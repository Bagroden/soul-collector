# Активные способности игрока

## Обзор
Активные способности - это специальные действия, которые игрок может использовать в бою. Каждая способность имеет свои требования к ресурсам, перезарядку и уникальные эффекты.

## Список активных способностей

### 1. Спиритический удар (Spiritual Strike)
- **Тип:** Магическая атака
- **Стоимость:** 15 ОМ
- **Перезарядка:** 0 ходов
- **Описание:** Наносит урон равный сумме всех характеристик игрока
- **Формула урона:** `Сумма всех характеристик + бонус от интеллекта`
- **Тип урона:** Магический
- **Особенности:**
  - Использует все характеристики игрока для расчета урона
  - Получает бонус от интеллекта к магическому урону
  - Критический удар зависит от магического шанса крита

### 2. Кинетический удар (Kinetic Strike)
- **Тип:** Физическая атака
- **Стоимость:** 0 ОМ, 0 ОВ
- **Перезарядка:** 0 ходов
- **Описание:** Мощная физическая атака
- **Тип урона:** Физический
- **Особенности:**
  - Базовая физическая способность
  - Не требует ресурсов для использования

### 3. Восстановление души (Soul Restoration)
- **Тип:** Лечебная способность
- **Стоимость:** 0 ОМ, 0 ОВ
- **Перезарядка:** 0 ходов
- **Заряды:** 2 заряда на забег по локации
- **Описание:** Восстанавливает 35% от максимального ОЗ, ОМ и ОВ
- **Эффект:**
  - Восстанавливает 35% от максимального здоровья
  - Восстанавливает 35% от максимальной маны
  - Восстанавливает 35% от максимальной выносливости
- **Особенности:**
  - **Ограниченное использование:** 2 заряда на весь забег по локации
  - **Восстановление зарядов:** Все заряды восстанавливаются в комнатах отдыха
  - **Улучшения:** Можно усилить через систему душ:
    - Дополнительные заряды
    - Увеличение эффективности восстановления
  - **Стратегическое значение:** Позволяет игроку восстановиться в критических ситуациях
  - **Не тратит очки действий:** Использование не заканчивает ход игрока

## Система зарядов "Восстановления души"

### Механика зарядов
- **Начальное количество:** 2 заряда
- **Восстановление:** Все заряды восстанавливаются при входе в комнату отдыха
- **Полное восстановление:** Все заряды восстанавливаются при возвращении на экран подготовки к путешествию:
  - После гибели игрока
  - После победы над боссом локации
  - При возвращении в колодец душ
- **Ограничение:** Заряды не восстанавливаются автоматически между боями
- **Сохранение:** Количество зарядов сохраняется между боями в рамках одного забега

### Улучшения через души
Система позволяет улучшать способность через специальные души:

#### Улучшения зарядов
- **Дополнительные заряды:** +1, +2, +3 заряда
- **Максимум:** До 5 зарядов с улучшениями

#### Улучшения эффективности
- **Бонус к восстановлению:** +5%, +10%, +15% к проценту восстановления
- **Максимум:** До 50% восстановления с улучшениями

### Стратегическое использование
1. **Экономия зарядов:** Используйте только в критических ситуациях
2. **Планирование:** Сохраняйте заряды для сложных боев
3. **Комнаты отдыха:** Используйте для полного восстановления всех зарядов
4. **Комбинирование:** Сочетайте с другими способностями для максимальной эффективности

## Техническая реализация

### Файлы системы
- `Scripts/Abilities/SoulRestoration.gd` - Основная способность
- `Scripts/Systems/SoulRestorationManager.gd` - Менеджер зарядов и улучшений
- `Scripts/Abilities/PlayerAbilities.gd` - Регистрация способности
- `Scripts/Battle/battle_manager.gd` - Обработка в бою
- `Scripts/Battle/ui_controller.gd` - UI кнопки и обновление состояния
- `Scripts/RoomSelector.gd` - Восстановление в комнатах отдыха и при возвращении
- `Scripts/UI/DefeatScreen.gd` - Восстановление зарядов после гибели

### Автозагрузка
- `SoulRestorationManager` добавлен в автозагрузку проекта
- Доступен глобально через `get_node("/root/SoulRestorationManager")`

### Сигналы
- `charges_changed(current_charges, max_charges)` - Изменение количества зарядов
- `soul_restoration_used(charges_remaining)` - Использование способности

### Восстановление зарядов
Система автоматически восстанавливает все заряды в следующих случаях:

#### 1. Комнаты отдыха
- **Файл:** `Scripts/RoomSelector.gd` → `_handle_rest_room()`
- **Условие:** Вход в комнату отдыха
- **Эффект:** Полное восстановление всех зарядов

#### 2. Возвращение на экран подготовки
- **Файл:** `Scripts/UI/DefeatScreen.gd` → `_return_to_character_preparation()`
- **Условие:** После гибели игрока
- **Эффект:** Полное восстановление всех зарядов

#### 3. Завершение локации
- **Файл:** `Scripts/RoomSelector.gd` → `_return_to_location_selector()`
- **Условие:** После победы над боссом локации
- **Эффект:** Полное восстановление всех зарядов

#### 4. Возвращение в колодец душ
- **Файл:** `Scripts/RoomSelector.gd` → `_on_back_pressed()`
- **Условие:** При возвращении в колодец душ
- **Эффект:** Полное восстановление всех зарядов

### Сохранение данных
```gdscript
{
    "max_charges": 2,
    "current_charges": 1,
    "restoration_percentage": 0.35,
    "soul_upgrades": {
        "charges": 0,
        "efficiency": 0.0
    }
}
```

## Баланс и геймплей

### Преимущества
- Дает игроку контроль над восстановлением
- Создает стратегические решения о том, когда использовать
- Ограниченное использование предотвращает злоупотребление
- Восстановление в комнатах отдыха поощряет их посещение

### Ограничения
- Ограниченное количество использований
- Не восстанавливает заряды между боями
- Требует планирования использования
- Эффективность зависит от максимальных характеристик

### Взаимодействие с другими системами
- **Пассивные способности:** Может взаимодействовать с регенерацией
- **Характеристики:** Эффективность зависит от максимальных значений
- **Комнаты отдыха:** Восстанавливают заряды во время забега
- **Система душ:** Позволяет улучшать способность
- **Экран подготовки:** Полное восстановление зарядов при возвращении
- **Система смерти:** Заряды восстанавливаются после гибели
- **Завершение локации:** Заряды восстанавливаются после победы над боссом

## Система множественных ударов

### Обзор
Некоторые активные способности наносят множественные удары за одно использование. Каждый удар обрабатывается отдельно с точки зрения уворота, попадания и пассивных способностей.

### Принципы работы
1. **Независимые проверки:** Каждый удар проверяется отдельно на уворот
2. **Отдельное логирование:** Каждый удар логируется отдельно в боевом логе
3. **Пассивные способности:** Срабатывают после каждого удара
4. **Контекст удара:** Каждый удар имеет свой номер (`hit_number`)

### Примеры способностей с множественными ударами

#### 1. Двойной удар (Double Strike)
- **Количество ударов:** 2
- **Механика:** Каждый удар наносит 50% от общего урона
- **Уворот:** Проверяется отдельно для каждого удара
- **Контекст:** `double_strike_1`, `double_strike_2`

#### 2. Магические стрелы (Magic Arrows)
- **Количество стрел:** 1 + (Интеллект ÷ 15)
- **Механика:** Каждая стрела наносит урон = Интеллект
- **Уворот:** Проверяется отдельно для каждой стрелы
- **Контекст:** `magic_arrow_1`, `magic_arrow_2`, `magic_arrow_N`

### Техническая реализация

#### Исключение из общей проверки уворота
```gdscript
# В battle_manager.gd
# Для способностей с множественными ударами не проверяем общий уворот
if not result.get("double_strike", false) and not result.get("magic_arrows", false):
    if not _calculate_hit_chance(enemy_node, player_node, "main_attack", enemy_ability_name):
        # Общая проверка уворота
```

#### Обработка каждого удара отдельно
```gdscript
# Для "Двойного удара"
if result.get("double_strike", false):
    # Первый удар
    if _calculate_hit_chance(enemy_node, player_node, "double_strike_1", "Двойной удар (1-й удар)"):
        player_node.take_damage(damage_per_hit, damage_type)
        # Пассивные способности после первого удара
        var context_attack_1 = {"hit_number": 1, ...}
        enemy_node.trigger_passive_abilities(TriggerType.ON_ATTACK, player_node, context_attack_1)
    
    # Второй удар
    if _calculate_hit_chance(enemy_node, player_node, "double_strike_2", "Двойной удар (2-й удар)"):
        player_node.take_damage(damage_per_hit, damage_type)
        # Пассивные способности после второго удара
        var context_attack_2 = {"hit_number": 2, ...}
        enemy_node.trigger_passive_abilities(TriggerType.ON_ATTACK, player_node, context_attack_2)

# Для "Магических стрел"
elif result.get("magic_arrows", false):
    for i in range(arrows_count):
        if _calculate_hit_chance(enemy_node, player_node, "magic_arrow_" + str(i+1), "Магическая стрела " + str(i+1)):
            player_node.take_damage(arrow_damage, damage_type)
            # Пассивные способности после каждой стрелы
            var context_arrow = {"hit_number": i+1, ...}
            enemy_node.trigger_passive_abilities(TriggerType.ON_ATTACK, player_node, context_arrow)
```

#### Логирование уворота
```gdscript
# В _calculate_hit_chance()
if context == "" or context == "main_attack" or context == "double_strike_1" or context == "double_strike_2" or context.begins_with("magic_arrow_"):
    # Логируем уворот для каждого удара отдельно
```

### Правила создания способностей с множественными ударами

#### 1. Исключение из общей проверки уворота
```gdscript
# Добавить флаг способности в исключения
if not result.get("double_strike", false) and not result.get("magic_arrows", false) and not result.get("your_ability", false):
```

#### 2. Обработка каждого удара
```gdscript
# Создать цикл для каждого удара
for i in range(hits_count):
    if _calculate_hit_chance(attacker, target, "ability_hit_" + str(i+1), "Название способности " + str(i+1)):
        target.take_damage(damage_per_hit, damage_type)
        # Пассивные способности после каждого удара
        var context_hit = {"hit_number": i+1, ...}
        attacker.trigger_passive_abilities(TriggerType.ON_ATTACK, target, context_hit)
```

#### 3. Логирование уворота
```gdscript
# Добавить контекст в логирование
if context.begins_with("your_ability_hit_"):
    # Логируем уворот для каждого удара
```

### Преимущества системы множественных ударов

#### Для игрока
- **Больше шансов на попадание:** Если первый удар промахнулся, второй может попасть
- **Стратегическая глубина:** Нужно учитывать уворот противника
- **Визуальная обратная связь:** Видно, какие удары попали, а какие нет

#### Для разработчиков
- **Модульность:** Легко добавлять новые способности с множественными ударами
- **Консистентность:** Все способности работают по единым правилам
- **Масштабируемость:** Система готова для любого количества ударов

### Примеры логов

#### Успешные удары
```
Player - Уворот (не сработала) от Двойной удар (1-й удар)
Player получил 50 урона
Player - Уворот (не сработала) от Двойной удар (2-й удар)  
Player получил 50 урона
```

#### Частичные попадания
```
Player увернулся от Двойной удар (1-й удар)!
Player - Уворот (не сработала) от Двойной удар (2-й удар)
Player получил 50 урона
```

#### Полные промахи
```
Player увернулся от Двойной удар (1-й удар)!
Player увернулся от Двойной удар (2-й удар)!
```

### Важные моменты

#### 1. Контекст удара
- **Обязательно указывайте `hit_number`** в контексте для пассивных способностей
- **Используйте уникальные контексты** для каждого удара (`ability_hit_1`, `ability_hit_2`)

#### 2. Логирование
- **Каждый удар логируется отдельно** в боевом логе
- **Уворот проверяется и логируется** для каждого удара
- **Пассивные способности срабатывают** после каждого удара

#### 3. Балансировка
- **Учитывайте уворот противника** при создании способностей
- **Множественные удары дают больше шансов** сработать пассивным способностям
- **Балансируйте урон** между количеством ударов и силой каждого удара

## Будущие улучшения

### Планируемые функции
- Визуальный индикатор зарядов в UI
- Звуковые эффекты при использовании
- Анимации восстановления
- Дополнительные улучшения через души

### Возможные расширения
- Временные бонусы к восстановлению
- Специальные эффекты при критическом здоровье
- Комбо-система с другими способностями
- Уникальные улучшения для разных классов персонажей
