# Исправление пересчета бонусов восстановления души

## Дата
28 октября 2025

## Проблема
После изучения способности первого уровня "Дополнительный заряд I" пользователь видел 2/4 заряда вместо 3/3.

### Анализ
- **Ожидаемо**: 2 базовых + 1 за способность = 3 максимум, 3 текущих
- **Фактически**: 2 текущих / 4 максимум
- **Проблема**: `soul_upgrades["charges"] = 2` вместо 1

### Причина
Бонусы НЕ пересчитывались при входе в бой, если игрок изучил способность и сразу пошел в бой без перезапуска игры.

**Сценарий проблемы:**
1. Игрок изучает способность → `execute_ability()` → `add_soul_upgrade("charges", 1)` → `soul_upgrades["charges"] = 1`
2. Сохранение игры → в файле сохраняется `soul_upgrades["charges"] = 1`
3. Игрок входит в бой → пересчет НЕ происходит
4. Игрок учит еще одну способность или происходит какая-то ошибка → бонус увеличивается еще раз

ИЛИ (старый баг):
1. До исправления бонусы накапливались при каждой инициализации
2. Пользователь успел накопить `soul_upgrades["charges"] = 2` или больше
3. Это значение сохранилось в файле
4. При загрузке оно загрузилось, но пересчет не произошел сразу

## Решение

### 1. Добавлен пересчет при входе в бой
```gdscript
// Scripts/Battle/battle_manager.gd

func _ready():
    # ...
    _initialize_passive_abilities()
    
    # Пересчитываем бонусы восстановления души перед боем
    var soul_restoration_manager = get_node_or_null("/root/SoulRestorationManager")
    if soul_restoration_manager:
        soul_restoration_manager.recalculate_bonuses_from_learned_abilities()
    
    # ...
```

### 2. Добавлена детальная отладка
В `SoulRestorationManager.recalculate_bonuses_from_learned_abilities()` добавлен вывод:
- Текущие бонусы ДО пересчета
- Информация о каждой проверяемой способности
- Итоговые бонусы ПОСЛЕ пересчета

### 3. Пересчет происходит в двух местах
1. **При загрузке игры**: `SoulRestorationManager._ready()` (с задержкой 0.1 сек)
2. **При входе в бой**: `battle_manager._ready()` (сразу после инициализации)

## Когда происходит пересчет

| Событие | Пересчет | Источник |
|---------|----------|----------|
| Загрузка игры | ✅ Да | `SoulRestorationManager._ready()` |
| Вход в бой | ✅ Да | `battle_manager._ready()` |
| Изучение способности | ❌ Нет | Применяется через `execute_ability()` |
| Открытие меню | ❌ Нет | Не требуется |

## Пример отладочного вывода

### Правильный пересчет (изучена одна способность "Заряды I"):
```
=== НАЧАЛО ПЕРЕСЧЕТА БОНУСОВ ВОССТАНОВЛЕНИЯ ДУШИ ===
Текущие бонусы ДО пересчета:
  Заряды: 2
  Эффективность: 0
  Барьер: 0
Бонусы сброшены к нулю
Всего изученных способностей: 4
  Проверяем способность: player_fortress
  Проверяем способность: player_strong
  Проверяем способность: player_wise
  Проверяем способность: soul_restoration_charges_1
Пересчет: Заряды уровень 1 = +1 заряд
=== Итоговые бонусы восстановления души ===
Заряды: +1
Эффективность: +0 %
Барьер: 0
```

**Результат**: Максимум зарядов = 2 (база) + 1 (бонус) = **3**

### Если было накопление (ошибка):
```
=== НАЧАЛО ПЕРЕСЧЕТА БОНУСОВ ВОССТАНОВЛЕНИЯ ДУШИ ===
Текущие бонусы ДО пересчета:
  Заряды: 2  ← ОШИБКА: накопилось
  Эффективность: 0
  Барьер: 0
Бонусы сброшены к нулю
...
=== Итоговые бонусы восстановления души ===
Заряды: +1  ← ИСПРАВЛЕНО
Эффективность: +0 %
Барьер: 0
```

**Результат**: Исправлено на правильное значение!

## Как это исправит проблему пользователя

### Что нужно сделать:
**Просто войдите в бой снова!**

При входе в бой:
1. Вызывается `battle_manager._ready()`
2. Вызывается `recalculate_bonuses_from_learned_abilities()`
3. Бонусы сбрасываются к 0
4. Бонусы пересчитываются на основе изученных способностей
5. Результат: **правильное количество зарядов**

### Проверка результата:
Откройте консоль (Output) и проверьте вывод:
```
=== Итоговые бонусы восстановления души ===
Заряды: +1    ← должен быть +1, если изучена одна способность
Эффективность: +5 %   ← должен быть +5%, если изучена одна способность
Барьер: 40    ← должен быть 40, если изучена одна способность
```

Затем проверьте в игре:
- **Максимум зарядов**: должен быть **3/3** (если изучена одна способность зарядов)
- **Процент восстановления**: должен быть **40%** (если изучена одна способность эффективности)

## Таблица правильных значений

### Если изучены только способности ПЕРВОГО уровня:

| Изученные способности | Максимум зарядов | % восстановления | Барьер |
|----------------------|------------------|------------------|---------|
| Только "Заряды I" | 3 | 35% (база) | 0 |
| Только "Эффективность I" | 2 (база) | 40% | 0 |
| Только "Барьер I" | 2 (база) | 35% (база) | 40 |
| Все три | 3 | 40% | 40 |

### Если изучены способности разных уровней:

| Способность | Максимум зарядов | % восстановления |
|-------------|------------------|------------------|
| Заряды I | 3 | - |
| Заряды I + Заряды II | 4 | - |
| Эффективность I | - | 40% |
| Эффективность I + II | - | 45% |
| Эффективность I + II + III | - | 55% |

## Дополнительные проверки

### Если проблема не исправилась:
1. Проверьте консоль - там должен быть вывод пересчета
2. Проверьте, какие способности изучены (должны быть только те, что вы купили)
3. Сообщите разработчику вывод из консоли

### Возможные причины, если не помогло:
1. Способность зарегистрирована несколько раз в `learned_passives`
2. ID способности неправильный
3. Функция пересчета не вызывается

## Изменения в файлах

### Scripts/Battle/battle_manager.gd
**Добавлено** в `_ready()`:
```gdscript
# Пересчитываем бонусы восстановления души перед боем
var soul_restoration_manager = get_node_or_null("/root/SoulRestorationManager")
if soul_restoration_manager:
    soul_restoration_manager.recalculate_bonuses_from_learned_abilities()
```

### Scripts/Systems/SoulRestorationManager.gd
**Добавлена** детальная отладка в `recalculate_bonuses_from_learned_abilities()`:
- Вывод текущих бонусов ДО пересчета
- Вывод количества изученных способностей
- Вывод каждой проверяемой способности
- Вывод итоговых бонусов ПОСЛЕ пересчета

## Результат
✅ Бонусы пересчитываются при каждом входе в бой
✅ Накопленные ошибочные значения исправляются автоматически
✅ Детальная отладка помогает диагностировать проблемы
✅ Пользователь должен увидеть правильное количество зарядов (3/3 для одной изученной способности)

