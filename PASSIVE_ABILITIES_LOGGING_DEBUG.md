# Отладка логирования пассивных способностей

## Проблема найдена!
Пассивные способности **РАБОТАЮТ** (видно в отладке), но **НЕ ЛОГИРУЮТСЯ** в боевой лог.

## Анализ отладочных логов

### Что работает:
- **Пассивные способности срабатывают** - видно в отладке:
  ```
  Срабатывает способность: Поглощение маны (mana_absorption)
  Результат: { "success": true, "mana_restored": 6, "message": "Player поглощает 6 маны из нанесенного урона!" }
  ```

- **Способности имеют эффекты** - "Player поглощает 6 маны", "Слизень восстанавливает 6 HP", "Слизень разрушает 1.0 брони"

### Что не работает:
- **Логирование в боевой лог** - эти сообщения не попадают в боевой лог
- **Функция `_log_passive_ability` не вызывается** или не работает

## Корневая причина

### Проблема в функции `_log_passive_ability`:
1. **Функция вызывается** - код в `trigger_passive_abilities` правильный
2. **Но логирование не работает** - сообщения не попадают в боевой лог
3. **Возможные причины:**
   - `battle_log` не найден
   - Функция `log_passive_ability` не работает
   - Сообщения фильтруются

## Усиленная отладка

### Добавлена отладочная информация в `_log_passive_ability`:
```gdscript
func _log_passive_ability(ability_name: String, success: bool, message: String):
    print("=== ОТЛАДКА _log_passive_ability ===")
    print("Способность: ", ability_name)
    print("Успех: ", success)
    print("Сообщение: ", message)
    
    # Список статических способностей, которые не нужно логировать
    var static_abilities = [
        "Крепость", "Сильный", "Мудрый", "Живучесть",  # Игрок
        "Крысиная сила", "Крысиная ловкость",  # Крыса (статические)
        "Мышиная стая", "Мышиная ловкость", "Мышиная сила",  # Мышь
        "Слизистая броня", "Живучесть слизня", "Массивный",  # Слизень (статические)
        "Демон колдун", "Демоническая выносливость",  # Демоны
        "Сила демона", "Владыка демонов", "Броня Тарнока"  # Другие демоны
    ]
    
    # Не логируем статические способности
    if ability_name in static_abilities:
        print("Статическая способность, не логируем: ", ability_name)
        return
    
    # Если способность не сработала, проверяем настройку
    if not success or message == "":
        var settings_manager = get_node_or_null("/root/SettingsManager")
        if settings_manager and not settings_manager.get_show_failed_ability_logs():
            print("Настройка отключена для неудачных способностей")
            return  # Не показываем несработавшие способности, если настройка выключена
    
    # Получаем battle_log из battle_manager
    var battle_manager = get_node_or_null("/root/BattleScene")
    if battle_manager and battle_manager.has_method("get_battle_log"):
        var battle_log = battle_manager.get_battle_log()
        if battle_log:
            print("Логируем через battle_manager: ", ability_name)
            battle_log.log_passive_ability(display_name, ability_name, success, message)
        else:
            print("battle_log не найден через battle_manager")
    else:
        # Fallback: ищем battle_log напрямую
        var battle_log = get_node_or_null("/root/BattleScene/BattleLog")
        if battle_log:
            print("Логируем через fallback: ", ability_name)
            battle_log.log_passive_ability(display_name, ability_name, success, message)
        else:
            print("battle_log не найден через fallback")
    
    print("=== КОНЕЦ ОТЛАДКИ _log_passive_ability ===")
```

## Ожидаемые результаты отладки

### При следующем запуске должно быть:
```
=== ОТЛАДКА _log_passive_ability ===
Способность: Поглощение маны
Успех: true
Сообщение: Player поглощает 6 маны из нанесенного урона!
Логируем через battle_manager: Поглощение маны
=== КОНЕЦ ОТЛАДКИ _log_passive_ability ===
```

## Возможные проблемы и решения

### 1. **Статические способности фильтруются**
**Симптом:** "Статическая способность, не логируем: [название]"
**Решение:** Проверить список статических способностей

### 2. **battle_log не найден**
**Симптом:** "battle_log не найден через battle_manager" или "battle_log не найден через fallback"
**Решение:** Проверить инициализацию battle_log в тестовом режиме

### 3. **Настройки отключены**
**Симптом:** "Настройка отключена для неудачных способностей"
**Решение:** Проверить настройки логирования

### 4. **Функция log_passive_ability не работает**
**Симптом:** "Логируем через battle_manager: [название]" но сообщение не появляется
**Решение:** Проверить работу функции log_passive_ability в BattleLog

## Следующие шаги

### 1. **Запустить тест с отладкой**
- Запустить тестовую арену
- Посмотреть на новые отладочные сообщения
- Определить, где именно проблема

### 2. **Проверить battle_log**
- Убедиться, что battle_log инициализируется
- Проверить, что он доступен в тестовом режиме

### 3. **Проверить фильтрацию**
- Убедиться, что способности не фильтруются
- Проверить список статических способностей

### 4. **Проверить настройки**
- Убедиться, что настройки логирования включены
- Проверить, что сообщения не блокируются

## Ожидаемые результаты

### **Если все работает правильно:**
- Отладочные сообщения покажут, что логирование работает
- Пассивные способности появятся в боевом логе
- Боевой лог будет содержать информацию о пассивных способностях

### **Если есть проблемы:**
- Отладочные сообщения покажут, где именно проблема
- Можно будет исправить конкретную проблему
- Боевой лог заработает как в обычном режиме

---

**Автор**: Claude AI Assistant  
**Дата**: 2024  
**Версия**: 1.0
