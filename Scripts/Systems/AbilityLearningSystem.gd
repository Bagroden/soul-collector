# Scripts/Systems/AbilityLearningSystem.gd
extends Node

signal ability_learned(ability_id: String, progress: int)
signal progress_updated(ability_id: String, progress: int)

# Конфигурация изучения способностей
var ability_learning_config = {}
# Текущий прогресс изучения
var learning_progress = {}

func _ready():
	_initialize_learning_config()
	_load_progress()
	_force_fix_ability_levels()  # ПРИНУДИТЕЛЬНОЕ исправление уровней

func _initialize_learning_config():
	"""Инициализация конфигурации изучения способностей"""
	ability_learning_config = {
		"rat_vitality": {
			"name": "Крысиная живучесть",
			"description": "Восстанавливает X HP за раунд",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [5, 8, 12],  # 5/8/12 HP за раунд
			"sources": {
				"common_rat": 100,      # 100 очков за обычную крысу
				"uncommon_rat": 100,    # 100 очков за необычную крысу
				"rare_rat": 100,        # 100 очков за редкую крысу
				"epic_rat": 100,        # 100 очков за эпическую крысу
				"legendary_rat": 100   # 100 очков за легендарную крысу
			}
		},
		"dodge": {
			"name": "Уворот",
			"description": "X% шанс увернуться от атаки",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [10, 17, 30],  # 10%/17%/30% шанс уворота
			"sources": {
				"uncommon_rat": 100,   # 100 очков за необычную крысу
				"rare_rat": 100,        # 100 очков за редкую крысу
				"epic_rat": 100,        # 100 очков за эпическую крысу
				"legendary_rat": 100   # 100 очков за легендарную крысу
			}
		},
		"blood_flow": {
			"name": "Кровоток",
			"description": "X% шанс вызвать кровотечение. Каждый стак кровотечения отнимает 2% от максимума ОЗ. Максимум 5 стаков.",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [15, 25, 40],  # 15%/25%/40% шанс кровотечения
			"sources": {
				"rare_rat": 100,        # 100 очков за редкую крысу
				"epic_rat": 100,        # 100 очков за эпическую крысу
				"legendary_rat": 100,   # 100 очков за легендарную крысу
				"rare_гоблин_воин": 30,  # 30 очков за редкого гоблина воина
				"epic_гоблин_воин": 40,   # 40 очков за эпического гоблина воина
				"legendary_гоблин_воин": 50  # 50 очков за легендарного гоблина воина
			}
		},
		"agility": {
			"name": "Изворотливость",
			"description": "При уклонении X% шанс контратаки (Урон контратаки = сила + ловкость)",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20, 30, 45],  # 20%/30%/45% шанс контратаки
			"sources": {
				"epic_rat": 100,        # 100 очков за эпическую крысу
				"legendary_rat": 100    # 100 очков за легендарную крысу
			}
		},
		"cornered": {
			"name": "Загнанный в угол",
			"description": "При HP < X% увеличивает урон на Y%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20, 25, 30],  # Пороги HP: 20%/25%/30%
			"level_values_secondary": [30, 50, 70],  # Бонусы урона: +30%/+50%/+70%
			"sources": {
				"legendary_rat": 100    # 100 очков за легендарную крысу
			}
		},
		# Общие способности
		"speed": {
			"name": "Скорость",
			"description": "X% шанс дополнительного действия",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [7, 12, 20],  # 7%/12%/20% шанс дополнительного действия
			"sources": {
				"common_Летучая мышь": 100,      # 100 очков за обычную летучую мышь
				"uncommon_Летучая мышь": 100,    # 100 очков за необычную летучую мышь
				"rare_Летучая мышь": 100,        # 100 очков за редкую летучую мышь
				"epic_Летучая мышь": 100,        # 100 очков за эпическую летучую мышь
				"legendary_Летучая мышь": 100,   # 100 очков за легендарную летучую мышь
				"elite_Летучая мышь": 100        # 100 очков за элитную летучую мышь
			}
		},
		"sharp_claws": {
			"name": "Острые когти",
			"description": "X% шанс нанести рану. Максимум 3 стака. (Снижение эффективности лечения на 20% за стак)",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [15, 25, 40],  # 15%/25%/40% шанс раны
			"sources": {
				"uncommon_Летучая мышь": 100,   # 100 очков за необычную летучую мышь
				"rare_Летучая мышь": 100,        # 100 очков за редкую летучую мышь
				"epic_Летучая мышь": 100,        # 100 очков за эпическую летучую мышь
				"legendary_Летучая мышь": 100,   # 100 очков за легендарную летучую мышь
				"elite_Летучая мышь": 100        # 100 очков за элитную летучую мышь
			}
		},
		"blood_sucker": {
			"name": "Кровосос",
			"description": "X% шанс вампиризма при атаке",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [15, 30, 45],  # 15%/30%/45% шанс вампиризма
			"sources": {
				"rare_Летучая мышь": 100,        # 100 очков за редкую летучую мышь
				"epic_Летучая мышь": 100,        # 100 очков за эпическую летучую мышь
				"legendary_Летучая мышь": 100,   # 100 очков за легендарную летучую мышь
				"elite_Летучая мышь": 100        # 100 очков за элитную летучую мышь
			}
		},
		"echolocation": {
			"name": "Эхолокация",
			"description": "Игнорирует X% уворота",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [10, 20, 40],  # Игнорирует 10%/20%/40% уворота
			"sources": {
				"epic_Летучая мышь": 100,        # 100 очков за эпическую летучую мышь
				"legendary_Летучая мышь": 100,   # 100 очков за легендарную летучую мышь
				"elite_Летучая мышь": 100        # 100 очков за элитную летучую мышь
			}
		},
		"silent_song": {
			"name": "Песня тишины",
			"description": "X% шанс снизить вероятность срабатывания магического урона",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [10, 20, 30],  # 10%/20%/30% шанс
			"sources": {
				"legendary_Летучая мышь": 100,   # 100 очков за легендарную летучую мышь
				"elite_Летучая мышь": 100        # 100 очков за элитную летучую мышь
			}
		},
		"quick_strike": {
			"name": "Быстрый удар",
			"description": "X% шанс двойной атаки с уменьшенным уроном",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20, 30, 40],  # 20%/30%/40% шанс двойной атаки
			"sources": {
				"common_мышь": 100,      # 100 очков за обычную мышь
				"uncommon_мышь": 100,    # 100 очков за необычную мышь
				"rare_мышь": 100,        # 100 очков за редкую мышь
				"epic_мышь": 100,        # 100 очков за эпическую мышь
				"legendary_мышь": 100   # 100 очков за легендарную мышь
			}
		},
		"curse_weakness": {
			"name": "Проклятие слабости",
			"description": "Шанс 15%, снижает силу врага на X%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20, 30, 45],  # -20%/-30%/-45% силы врага
			"sources": {
				"common_CurseDemon": 100,      # 100 очков за обычного демона проклятия
				"uncommon_CurseDemon": 100,    # 100 очков за необычного демона проклятия
				"rare_CurseDemon": 100,        # 100 очков за редкого демона проклятия
				"epic_CurseDemon": 100,        # 100 очков за эпического демона проклятия
				"legendary_CurseDemon": 100   # 100 очков за легендарного демона проклятия
			}
		},
		"curse_magic": {
			"name": "Демон колдун",
			"description": "Увеличивает магический урон на X%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20, 40, 60],  # +20%/+40%/+60% магический урон
			"sources": {
				"uncommon_CurseDemon": 100,    # 100 очков за необычного демона проклятия
				"rare_CurseDemon": 100,        # 100 очков за редкого демона проклятия
				"epic_CurseDemon": 100,        # 100 очков за эпического демона проклятия
				"legendary_CurseDemon": 100   # 100 очков за легендарного демона проклятия
			}
		},
		"curse_cursed": {
			"name": "Проклятый",
			"description": "Получает X защиты и X% магической защиты при получении урона",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [1, 2, 3],  # 1/2/3 защиты и 1%/2%/3% магической защиты
			"sources": {
				"epic_CurseDemon": 100,        # 100 очков за эпического демона проклятия
				"legendary_CurseDemon": 100   # 100 очков за легендарного демона проклятия
			}
		},
		"curse_master": {
			"name": "Мастер проклятий",
			"description": "Усиливает все проклятия на X%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [40, 65, 100],  # +40%/+65%/+100% эффективность проклятий
			"sources": {
				"legendary_CurseDemon": 100   # 100 очков за легендарного демона проклятия
			}
		},
		"executioner_guillotine": {
			"name": "Гильотина палача",
			"description": "Критический удар наносит +X% урона",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [50, 80, 120],  # Крит наносит +50%/+80%/+120% урона
			"sources": {
				"epic_ExecutionerDemon": 100,        # 100 очков за эпического демона палача
				"legendary_ExecutionerDemon": 100   # 100 очков за легендарного демона палача
			}
		},
		"executioner_judgment": {
			"name": "Суд палача",
			"description": "X% шанс наложить дебаф - Наказание. Наказание - наносит 50 урона и оглушает врага через 2 раунда",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [10, 15, 25],  # 10%/15%/25% шанс
			"sources": {
				"rare_ExecutionerDemon": 100,        # 100 очков за редкого демона палача
				"epic_ExecutionerDemon": 100,        # 100 очков за эпического демона палача
				"legendary_ExecutionerDemon": 100   # 100 очков за легендарного демона палача
			}
		},
		"executioner_rage": {
			"name": "Ярость палача",
			"description": "Увеличивает силу на X единиц за каждые 10% потерянного здоровья",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [5, 7, 10],  # +5/+7/+10 силы
			"sources": {
				"common_ExecutionerDemon": 100,      # 100 очков за обычного демона палача
				"uncommon_ExecutionerDemon": 100,    # 100 очков за необычного демона палача
				"rare_ExecutionerDemon": 100,        # 100 очков за редкого демона палача
				"epic_ExecutionerDemon": 100,        # 100 очков за эпического демона палача
				"legendary_ExecutionerDemon": 100   # 100 очков за легендарного демона палача
			}
		},
		"demon_mage": {
			"name": "Демон колдун",
			"description": "Увеличивает магический урон на X%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20, 40, 60],  # +20%/+40%/+60% магический урон
			"sources": {
				"rare_CurseDemon": 100,        # 100 очков за редкого демона проклятия
				"epic_CurseDemon": 100,        # 100 очков за эпического демона проклятия
				"legendary_CurseDemon": 100   # 100 очков за легендарного демона проклятия
			}
		},
		"demonic_endurance": {
			"name": "Демоническая выносливость",
			"description": "Восстанавливает X выносливости за раунд",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [15, 25, 40],  # +15/+25/+40 выносливости за раунд
			"sources": {
				"uncommon_ExecutionerDemon": 100,    # 100 очков за необычного демона палача
				"rare_ExecutionerDemon": 100,        # 100 очков за редкого демона палача
				"epic_ExecutionerDemon": 100,        # 100 очков за эпического демона палача
				"legendary_ExecutionerDemon": 100   # 100 очков за легендарного демона палача
			}
		},
		"executioner_final": {
			"name": "Последний приговор",
			"description": "При смерти ОЗ фиксируется на 1 и наносит контратаку с +X% шансом критического урона. Урон контратаки = сила + ловкость",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [20, 50, 100],  # +20%/+50%/+100% шанс крита
			"sources": {
				"legendary_ExecutionerDemon": 100
			}
		},
		# Способности Демона Алкары
		"alkara_vampirism": {
			"name": "Вампиризм Алкары",
			"description": "Восстанавливает X% от магического урона в HP",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [3, 7, 10],  # 3%/7%/10% магического урона в HP
			"sources": {
				"common_AlkaraDemon": 100,
				"uncommon_AlkaraDemon": 100,
				"rare_AlkaraDemon": 100,
				"epic_AlkaraDemon": 100,
				"legendary_AlkaraDemon": 100
			}
		},
		"alkara_blood_ritual": {
			"name": "Кровавый ритуал Алкары",
			"description": "Каждый ход жертвует 10/15/20 HP для усиления атак на +X% урона",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 50, 75],  # +30%/+50%/+75% урон, -10/-15/-20 HP
			"sources": {
				"rare_AlkaraDemon": 100,
				"epic_AlkaraDemon": 100,
				"legendary_AlkaraDemon": 100
			}
		},
		"alkara_soul_drain": {
			"name": "Похищение душ Алкары",
			"description": "Увеличивает получение осколков душ на +X%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 50, 80],  # +30%/+50%/+80% осколков душ
			"sources": {
				"epic_AlkaraDemon": 100,
				"legendary_AlkaraDemon": 100
			}
		},
		"alkara_demon_lord": {
			"name": "Повелитель демонов Алкары",
			"description": "Усиливает все демонические способности на +X%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 50, 75],  # +30%/+50%/+75% эффективность
			"sources": {
				"legendary_AlkaraDemon": 100
			}
		},
		# Способности Демона Тарнока
		"tharnok_shield": {
			"name": "Щит Тарнока",
			"description": "Блокирует X% входящего урона",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10, 20, 30],  # Блокирует 10%/20%/30% урона
			"sources": {
				"common_TharnokDemon": 100,
				"uncommon_TharnokDemon": 100,
				"rare_TharnokDemon": 100,
				"epic_TharnokDemon": 100,
				"legendary_TharnokDemon": 100
			}
		},
		"tharnok_armor": {
			"name": "Броня Тарнока",
			"description": "Увеличивает защиту на X единиц",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [20, 35, 55],  # +20/+35/+55 защиты
			"sources": {
				"uncommon_TharnokDemon": 100,
				"rare_TharnokDemon": 100,
				"epic_TharnokDemon": 100,
				"legendary_TharnokDemon": 100
			}
		},
		"tharnok_guardian": {
			"name": "Страж Тарнока",
			"description": "Отражает X% урона атакующему",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [20, 35, 50],  # 20%/35%/50% отражения урона
			"sources": {
				"epic_TharnokDemon": 100,
				"legendary_TharnokDemon": 100
			}
		},
		"tharnok_mastery": {
			"name": "Стойкость Тарнока",
			"description": "При получении урона получает стаки 'Кровь демона'. Каждый стак дает X% регенерацию здоровья за раунд. Максимум 5 стаков.",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [1, 2, 3],  # 1%/2%/3% регенерация за стак
			"sources": {
				"legendary_TharnokDemon": 100
			}
		},
		"demon_vitality": {
			"name": "Демоническая живучесть",
			"description": "Увеличивает живучесть на X единиц",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 50, 75],  # +30/+50/+75 живучести
			"sources": {
				"rare_CurseDemon": 100,
				"epic_CurseDemon": 100,
				"legendary_CurseDemon": 100,
				"rare_TharnokDemon": 100,
				"epic_TharnokDemon": 100,
				"legendary_TharnokDemon": 100
			}
		},
		# Способности слизня
		"slime_armor": {
			"name": "Слизистая броня",
			"description": "Снижает входящий урон на X ед благодаря слизистой оболочке",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [3, 6, 10],  # снижение получаемого урона на 3/6/10 ед
			"sources": {
				"common_слизень": 100,      # 100 очков за обычного слизня
				"uncommon_слизень": 100,    # 100 очков за необычного слизня
				"rare_слизень": 100,        # 100 очков за редкого слизня
				"epic_слизень": 100,        # 100 очков за эпического слизня
				"legendary_слизень": 100,   # 100 очков за легендарного слизня
				"boss_гнилой_слизень": 100  # 100 очков за босса гнилого слизня
			}
		},
		"acid_hits": {
			"name": "Кислотные удары",
			"description": "35% шанс при физических атаках разрушить X брони за удар",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [1, 2, 4],  # Разрушает 1/2/4 брони за удар
			"sources": {
				"uncommon_слизень": 100,    # 100 очков за необычного слизня
				"rare_слизень": 100,        # 100 очков за редкого слизня
				"epic_слизень": 100,        # 100 очков за эпического слизня
				"legendary_слизень": 100,   # 100 очков за легендарного слизня
				"boss_гнилой_слизень": 100  # 100 очков за босса гнилого слизня
			}
		},
		"slime_regeneration": {
			"name": "Регенерация слизи",
			"description": "Восстанавливает X + 1% от Максимума HP за раунд",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [4, 9, 15],  # 4+1%/9+2%/15+4% от Максимума HP за раунд
			"sources": {
				"rare_слизень": 100,        # 100 очков за редкого слизня
				"epic_слизень": 100,        # 100 очков за эпического слизня
				"legendary_слизень": 100,   # 100 очков за легендарного слизня
				"boss_гнилой_слизень": 100  # 100 очков за босса гнилого слизня
			}
		},
		"slime_vitality": {
			"name": "Живучесть слизня",
			"description": "Увеличивает здоровье на X%",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20, 35, 50],  # Увеличение здоровья на 20%/35%/50%
			"sources": {
				"epic_слизень": 100,        # 100 очков за эпического слизня
				"legendary_слизень": 100,   # 100 очков за легендарного слизня
				"boss_гнилой_слизень": 100  # 100 очков за босса гнилого слизня
			}
		},
		"massive": {
			"name": "Массивный",
			"description": "Увеличивает урон физических атак на X% от максимального здоровья",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [1, 2, 3],  # увеличивает урон физических атак на 1%/2%/3% от максимального здоровья (ослаблено в 2 раза)
			"sources": {
				"legendary_слизень": 100,   # 100 очков за легендарного слизня
				"boss_гнилой_слизень": 100  # 100 очков за босса гнилого слизня
			}
		},
		"rotten_aura": {
			"name": "Гнилостная аура",
			"description": "Каждый ход накладывает стак гнили на противника. Каждый стак наносит X% от максимального HP за раунд. Максимум 5 стаков. Гниль не имеет ограничений по длительности.",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [0.5, 0.7, 1.0],  # 0.5%/0.7%/1.0% HP за раунд за стак
			"sources": {
				"boss_гнилой_слизень": 100    # 100 очков за босса гнилого слизня
			}
		},
		"shadow_strike": {
			"name": "Теневой удар",
			"description": "При атаке X% шанс нанести дополнительный теневой урон, который игнорирует броню",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [15.0, 20.0, 25.0],  # 15%/20%/25% шанс теневого удара
			"sources": {
				"boss_тёмный_шатун": 100    # 100 очков за босса тёмного шатуна
			}
		},
		"shadow_aura": {
			"name": "Теневая аура",
			"description": "Пассивно увеличивает уворот на X%. Каждый ход Y% шанс войти в невидимость на 1 ход (+50% урон, +25% уворот)",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [5.0, 10.0, 15.0],  # 5%/10%/15% к увороту (пассивно)
			"secondary_values": [15.0, 20.0, 25.0],  # 15%/20%/25% шанс невидимости (активно)
			"sources": {
				"boss_тёмный_шатун": 100    # 100 очков за босса тёмного шатуна
			}
		},
		"stealth": {
			"name": "Скрытность",
			"description": "X% шанс стать невидимым при атаке на 2 раунда. Невидимость не дает выбрать вас целью атаки. Первая атака из невидимости прерывает невидимость и считается атакой в спину.",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [15.0, 25.0, 40.0],  # 15%/25%/40% шанс
			"sources": {
				"boss_тёмный_шатун": 100,    # 100 очков за босса тёмного шатуна
				"epic_Орк убийца": 100,
				"legendary_Орк убийца": 100
			}
		},
		"fighter": {
			"name": "Боец",
			"description": "Увеличивает физический урон на X%",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [10.0, 20.0, 30.0],  # 10%/20%/30% увеличение урона
			"sources": {
				"common_гоблин_воин": 10,    # 10 очков за обычного гоблина воина
				"uncommon_гоблин_воин": 20,  # 20 очков за необычного гоблина воина
				"rare_гоблин_воин": 30       # 30 очков за редкого гоблина воина
			}
		},
		"restlessness": {
			"name": "Суетливость",
			"description": "X% шанс двойной атаки с уменьшенным уроном на Y%",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [20.0, 30.0, 40.0],  # 20%/30%/40% шанс двойной атаки
			"sources": {
				"common_гоблин_воин": 10,    # 10 очков за обычного гоблина воина
				"uncommon_гоблин_воин": 20,  # 20 очков за необычного гоблина воина
				"rare_гоблин_воин": 30       # 30 очков за редкого гоблина воина
			}
		},
		"rage": {
			"name": "Ярость",
			"description": "Каждое получение урона дает +X к физическому урону на 3 раунда. Бонус стакается",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [1, 2, 3],  # 1/2/3 к физическому урону
			"sources": {
				"epic_гоблин_воин": 40,       # 40 очков за эпического гоблина воина
				"legendary_гоблин_воин": 50,  # 50 очков за легендарного гоблина воина
				"elite_гоблин_воин": 60       # 60 очков за элитного гоблина воина
			}
		},
		"revenge": {
			"name": "Месть",
			"description": "За каждые потерянные X ОЗ, в следующем раунде получает бонусное 1 ОД",
			"required_progress": [100, 500, 1000],  # Прогресс для каждого уровня
			"required_soul_shards": [100, 1000, 10000],  # Осколки душ для каждого уровня
			"level_values": [200, 150, 100],  # 200/150/100 ОЗ за бонусное ОД
			"sources": {
				"rare_гоблин_воин": 30,      # 30 очков за редкого гоблина воина
				"epic_гоблин_воин": 40,      # 40 очков за эпического гоблина воина
				"legendary_гоблин_воин": 50  # 50 очков за легендарного гоблина воина
			}
		},
		# Способности Гоблина Вора
		"thief_agility": {
			"name": "Ловкость вора",
			"description": "Увеличивает ловкость на X единиц",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [5, 10, 15],  # +5/+10/+15 ловкости
			"sources": {
				"common_гоблин_вор": 100,      # 100 очков за обычного гоблина вора
				"uncommon_гоблин_вор": 100,    # 100 очков за необычного гоблина вора
				"rare_гоблин_вор": 100,        # 100 очков за редкого гоблина вора
				"epic_гоблин_вор": 100,        # 100 очков за эпического гоблина вора
				"legendary_гоблин_вор": 100   # 100 очков за легендарного гоблина вора
			}
		},
		"sneaky_strike": {
			"name": "Подлый удар",
			"description": "X% шанс при атаке игнорировать броню цели",
			"rarity": "rare",  # Редкая способность
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10, 20, 30],  # 10%/20%/30% шанс игнорировать броню
			"sources": {
				"uncommon_гоблин_вор": 100,    # 100 очков за необычного гоблина вора
				"rare_гоблин_вор": 100,        # 100 очков за редкого гоблина вора
				"epic_гоблин_вор": 100,        # 100 очков за эпического гоблина вора
				"legendary_гоблин_вор": 100   # 100 очков за легендарного гоблина вора
			}
		},
		"neurotoxin": {
			"name": "Нейротоксин",
			"description": "X% шанс при атаке наложить нейротоксин. Нейротоксин уменьшает меткость цели на 5%/10%/15% за стак. Максимум 3 стака",
			"rarity": "legendary",  # Легендарная способность
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [17, 25, 35],  # 17%/25%/35% шанс нейротоксина
			"sources": {
				"rare_гоблин_вор": 100,        # 100 очков за редкого гоблина вора
				"epic_гоблин_вор": 100,        # 100 очков за эпического гоблина вора
				"legendary_гоблин_вор": 100   # 100 очков за легендарного гоблина вора
			}
		},
		# Способности Гоблина Колдуна
		"apprentice": {
			"name": "Ученик",
			"description": "Увеличивает запас маны на X единиц",
			"rarity": "common",  # Обычная способность
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 60, 100],  # +30/+60/+100 к запасу маны
			"sources": {
				"common_гоблин_колдун": 100,      # 100 очков за обычного гоблина колдуна
				"uncommon_гоблин_колдун": 100,    # 100 очков за необычного гоблина колдуна
				"rare_гоблин_колдун": 100,        # 100 очков за редкого гоблина колдуна
				"epic_гоблин_колдун": 100,        # 100 очков за эпического гоблина колдуна
				"legendary_гоблин_колдун": 100   # 100 очков за легендарного гоблина колдуна
			}
		},
		"magic_resistance": {
			"name": "Сопротивление магии",
			"description": "Получает X% сопротивление магии",
			"rarity": "uncommon",  # Необычная способность
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [7, 15, 25],  # 7%/15%/25% сопротивление магии
			"sources": {
				"uncommon_гоблин_колдун": 100,    # 100 очков за необычного гоблина колдуна
				"rare_гоблин_колдун": 100,        # 100 очков за редкого гоблина колдуна
				"epic_гоблин_колдун": 100,        # 100 очков за эпического гоблина колдуна
				"legendary_гоблин_колдун": 100   # 100 очков за легендарного гоблина колдуна
			}
		},
		"magic_barrier": {
			"name": "Магический барьер",
			"description": "Создает барьер = Мудрость × (1.5/2.0/2.5) в зависимости от уровня. Барьер блокирует урон и некоторые статусные эффекты",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [1.5, 2.0, 2.5],  # Множитель мудрости: 1.5/2.0/2.5
			"sources": {
				"rare_гоблин_колдун": 100,        # 100 очков за редкого гоблина колдуна
				"epic_гоблин_колдун": 100,        # 100 очков за эпического гоблина колдуна
				"legendary_гоблин_колдун": 100   # 100 очков за легендарного гоблина колдуна
			}
		},
		"mana_absorption": {
			"name": "Поглощение маны",
			"description": "X% от нанесенного урона преобразуется в ману",
			"rarity": "epic",  # Эпическая способность
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [5, 10, 15],  # 5%/10%/15% от урона в ману
			"sources": {
				"rare_гоблин_колдун": 100,        # 100 очков за редкого гоблина колдуна
				"epic_гоблин_колдун": 100,        # 100 очков за эпического гоблина колдуна
				"legendary_гоблин_колдун": 100   # 100 очков за легендарного гоблина колдуна
			}
		},
		"storm_shaman": {
			"name": "Шаман бурь",
			"description": "При нанесении любого магического урона есть шанс X% вызвать удар молнии. Удар молнии наносит магический урон = интеллект + мудрость",
			"rarity": "legendary",  # Легендарная способность
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [5, 10, 15],  # 5%/10%/15% шанс удара молнии
			"sources": {
				"epic_гоблин_колдун": 100,        # 100 очков за эпического гоблина колдуна
				"legendary_гоблин_колдун": 100   # 100 очков за легендарного гоблина колдуна
			}
		},
		# ===== СПОСОБНОСТИ СКЕЛЕТА АРБАЛЕТЧИКА =====
		"bone_precision": {
			"name": "Костяная точность",
			"description": "Увеличивает меткость на X%",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10, 20, 35],
			"sources": {
				"common_Скелет Арбалетчик": 100,
				"uncommon_Скелет Арбалетчик": 100,
				"rare_Скелет Арбалетчик": 100,
				"epic_Скелет Арбалетчик": 100,
				"legendary_Скелет Арбалетчик": 100
			}
		},
		"deadeye": {
			"name": "Мертвый глаз",
			"description": "Увеличивает шанс критического удара на X%",
			"rarity": "uncommon",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [7, 12, 20],
			"sources": {
				"uncommon_Скелет Арбалетчик": 100,
				"rare_Скелет Арбалетчик": 100,
				"epic_Скелет Арбалетчик": 100,
				"legendary_Скелет Арбалетчик": 100
			}
		},
		"piercing_bolt": {
			"name": "Пробивающий болт",
			"description": "25% шанс игнорировать X% защиты цели",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 50, 70],
			"sources": {
				"rare_Скелет Арбалетчик": 100,
				"epic_Скелет Арбалетчик": 100,
				"legendary_Скелет Арбалетчик": 100
			}
		},
		"undead_focus": {
			"name": "Нежить фокус",
			"description": "Каждый ход накапливает концентрацию, увеличивающую урон на X% за стак. Максимум 5 стаков. Сбрасывается при получении урона.",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [5, 8, 12],
			"sources": {
				"epic_Скелет Арбалетчик": 100,
				"legendary_Скелет Арбалетчик": 100
			}
		},
		"headshot": {
			"name": "Выстрел в голову",
			"description": "Критические удары наносят дополнительно X% урона",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [60, 100, 150],
			"sources": {
				"legendary_Скелет Арбалетчик": 100
			}
		},
		# ===== СПОСОБНОСТИ СКЕЛЕТА МЕЧНИКА =====
		"bone_parry": {
			"name": "Костяное парирование",
			"description": "X% шанс заблокировать Y% входящего урона",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [20, 25, 30],
			"level_values_secondary": [30, 40, 50],
			"sources": {
				"common_Скелет Мечник": 100,
				"uncommon_Скелет Мечник": 100,
				"rare_Скелет Мечник": 100,
				"epic_Скелет Мечник": 100,
				"legendary_Скелет Мечник": 100
			}
		},
		"riposte": {
			"name": "Ответный удар",
			"description": "При блокировании урона X% шанс контратаковать. Урон контратаки = сила + ловкость",
			"rarity": "uncommon",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [25, 40, 60],
			"sources": {
				"uncommon_Скелет Мечник": 100,
				"rare_Скелет Мечник": 100,
				"epic_Скелет Мечник": 100,
				"legendary_Скелет Мечник": 100
			}
		},
		"blade_mastery": {
			"name": "Мастерство клинка",
			"description": "Увеличивает физический урон на X%",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [20, 35, 55],
			"sources": {
				"rare_Скелет Мечник": 100,
				"epic_Скелет Мечник": 100,
				"legendary_Скелет Мечник": 100
			}
		},
		"aggressive_defense": {
			"name": "Агрессивная защита",
			"description": "После парирования/блока получает стак 'Импульса' на 3 раунда. Каждый стак: +5% скорость и +3% крит. Максимум 5 стаков.",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [5, 5, 5],
			"level_values_secondary": [3, 3, 3],
			"sources": {
				"epic_Скелет Мечник": 100,
				"legendary_Скелет Мечник": 100
			}
		},
		"death_dance": {
			"name": "Танец смерти",
			"description": "После каждой атаки получает стак 'Танца' на 3 раунда. Каждый стак увеличивает урон на X% и уворот на Y%. Максимум 3 стака.",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10, 15, 25],
			"level_values_secondary": [5, 8, 12],
			"sources": {
				"legendary_Скелет Мечник": 100
			}
		},
		# ===== СПОСОБНОСТИ ГУЛЯ =====
		"ghoul_feast": {
			"name": "Пир гуля",
			"description": "Восстанавливает X% HP при нанесении урона (вампиризм)",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [15, 25, 40],
			"sources": {
				"common_Гуль": 100,
				"uncommon_Гуль": 100,
				"rare_Гуль": 100,
				"epic_Гуль": 100,
				"legendary_Гуль": 100
			}
		},
		"rotting_claws": {
			"name": "Гнилые когти",
			"description": "X% шанс наложить дебаф 'Трупный яд'. Снижает меткость и скорость на Y% за стак. Максимум 3 стака.",
			"rarity": "uncommon",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 40, 50],
			"level_values_secondary": [5, 8, 12],
			"sources": {
				"uncommon_Гуль": 100,
				"rare_Гуль": 100,
				"epic_Гуль": 100,
				"legendary_Гуль": 100
			}
		},
		"corpse_eater": {
			"name": "Пожиратель трупов",
			"description": "При убийстве врага восстанавливает X% HP и получает +Y% урона на 3 раунда",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [15, 25, 40],
			"level_values_secondary": [15, 25, 40],
			"sources": {
				"rare_Гуль": 100,
				"epic_Гуль": 100,
				"legendary_Гуль": 100
			}
		},
		"plague_carrier": {
			"name": "Носитель чумы",
			"description": "Каждый ход накладывает стак 'Чумы'. Снижает макс HP на X% за стак. Максимум 5 стаков.",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [2, 3, 5],
			"sources": {
				"epic_Гуль": 100,
				"legendary_Гуль": 100
			}
		},
		"undying_hunger": {
			"name": "Неугасимый голод",
			"description": "При получении смертельного урона восстанавливает X% HP. Срабатывает один раз за бой.",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [25, 40, 60],
			"sources": {
				"legendary_Гуль": 100
			}
		},
		# ===== СПОСОБНОСТИ ЭЛИТНОГО СКЕЛЕТА =====
		"relentless": {
			"name": "Неумолимый",
			"description": "Игнорирует X% брони цели. Дополнительно +Y% за каждые 20% потерянного HP",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10, 15, 20],
			"level_values_secondary": [5, 8, 12],
			"sources": {
				"common_Элитный Скелет": 100,
				"uncommon_Элитный Скелет": 100,
				"rare_Элитный Скелет": 100,
				"epic_Элитный Скелет": 100,
				"legendary_Элитный Скелет": 100
			}
		},
		"heavy_strike": {
			"name": "Тяжелый удар",
			"description": "25% шанс нанести +X% урона и снизить защиту цели на Y",
			"rarity": "uncommon",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30, 50, 75],
			"level_values_secondary": [3, 5, 8],
			"sources": {
				"uncommon_Элитный Скелет": 100,
				"rare_Элитный Скелет": 100,
				"epic_Элитный Скелет": 100,
				"legendary_Элитный Скелет": 100
			}
		},
		"enchanted_bones": {
			"name": "Зачарованные кости",
			"description": "Увеличивает защиту на X единиц и магическое сопротивление на Y%",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10, 15, 20],
			"level_values_secondary": [7, 14, 21],
			"sources": {
				"rare_Элитный Скелет": 100,
				"epic_Элитный Скелет": 100,
				"legendary_Элитный Скелет": 100
			}
		},
		"shatter_bones": {
			"name": "Раздробление костей",
			"description": "X% шанс оглушить противника на 1 раунд",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10, 17, 25],
			"sources": {
				"epic_Элитный Скелет": 100,
				"legendary_Элитный Скелет": 100
			}
		},
		"undead_champion": {
			"name": "Чемпион нежити",
			"description": "Увеличивает все характеристики на X единиц",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [5, 10, 15],
			"sources": {
				"legendary_Элитный Скелет": 100
			}
		},
		# Способности орков
		"orc_marksmanship": {
			"name": "Точность орка",
			"description": "Увеличивает меткость на X%",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [12.0, 22.0, 38.0],  # +12%/+22%/+38% меткость
			"sources": {
				"common_Орк лучник": 100,
				"uncommon_Орк лучник": 100,
				"rare_Орк лучник": 100,
				"epic_Орк лучник": 100,
				"legendary_Орк лучник": 100
			}
		},
		"piercing_arrow": {
			"name": "Пробивающая стрела",
			"description": "Шанс игнорировать часть защиты цели",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [35.0, 55.0, 75.0],  # 35%/55%/75% игнорирования защиты
			"sources": {
				"rare_Орк лучник": 100,
				"epic_Орк лучник": 100,
				"legendary_Орк лучник": 100
			}
		},
		"rapid_fire": {
			"name": "Быстрая стрельба",
			"description": "Шанс дополнительного выстрела при атаке",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [20.0, 30.0, 45.0],  # 20%/30%/45% шанс
			"sources": {
				"epic_Орк лучник": 100,
				"legendary_Орк лучник": 100
			}
		},
		"bullseye": {
			"name": "Попадание в яблочко",
			"description": "Критические удары наносят огромный дополнительный урон",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [80.0, 120.0, 180.0],  # +80%/+120%/+180% урона от крита
			"sources": {
				"legendary_Орк лучник": 100
			}
		},
		"poison_blade": {
			"name": "Отравленный клинок",
			"description": "Шанс наложить яд при атаке",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [25.0, 35.0, 50.0],  # 25%/35%/50% шанс
			"sources": {
				"common_Орк убийца": 100,
				"uncommon_Орк убийца": 100,
				"rare_Орк убийца": 100,
				"epic_Орк убийца": 100,
				"legendary_Орк убийца": 100
			}
		},
		"backstab": {
			"name": "Удар в спину",
			"description": "Увеличенный урон при атаке сзади",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [0.5, 1.2, 2.0],  # +0.5/+1.2/+2.0 к базовому x1.5
			"sources": {
				"rare_Орк убийца": 100,
				"epic_Орк убийца": 100,
				"legendary_Орк убийца": 100
			}
		},
		"assassinate": {
			"name": "Убийство",
			"description": "Огромный урон при низком HP цели",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [2.5, 3.5, 5.0],  # x2.5/x3.5/x5.0 урон
			"sources": {
				"legendary_Орк убийца": 100
			}
		},
		"orc_rage": {
			"name": "Сила орка",
			"description": "Постоянное увеличение силы",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [10.0, 20.0, 30.0],  # +10/+20/+30 силы
			"sources": {
				"common_Орк берсерк": 100,
				"uncommon_Орк берсерк": 100,
				"rare_Орк берсерк": 100,
				"epic_Орк берсерк": 100,
				"legendary_Орк берсерк": 100
			}
		},
		"berserker_fury": {
			"name": "Боевое безумие",
			"description": "Получение стаков при получении урона. Увеличение урона и скорости за каждый стак. Максимум 5 стаков.",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [3.0, 5.0, 7.0],  # +3%/+5%/+7% к скорости и урону за стак
			"sources": {
				"rare_Орк берсерк": 100,
				"epic_Орк берсерк": 100,
				"legendary_Орк берсерк": 100
			}
		},
		"ork_vitality": {
			"name": "Выносливость орка",
			"description": "Снижение всего получаемого урона за каждый процент потерянного здоровья",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [0.1, 0.2, 0.3],  # 0.1%/0.2%/0.3% снижение урона за 1% потерянного HP
			"sources": {
				"epic_Орк берсерк": 100,
				"legendary_Орк берсерк": 100
			}
		},
		"berserk": {
			"name": "Берсерк",
			"description": "Огромный урон при критическом состоянии. Активируется при получении урона, если HP < 20%.",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [1.7, 2.2, 2.7],  # x1.7/x2.2/x2.7 урон при HP < 10%/15%/20%
			"sources": {
				"legendary_Орк берсерк": 100
			}
		},
		"orc_totem": {
			"name": "Тотем орка",
			"description": "Увеличивает магический урон",
			"rarity": "common",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [15.0, 25.0, 40.0],  # +15%/+25%/+40% магический урон
			"sources": {
				"common_Орк шаман": 100,
				"uncommon_Орк шаман": 100,
				"rare_Орк шаман": 100,
				"epic_Орк шаман": 100,
				"legendary_Орк шаман": 100
			}
		},
		"spirit_guard": {
			"name": "Духовный страж",
			"description": "Создает магический барьер, который поглощает урон",
			"rarity": "rare",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [1.8, 2.3, 3.0],  # Мудрость × 1.8/× 2.3/× 3.0
			"sources": {
				"rare_Орк шаман": 100,
				"epic_Орк шаман": 100,
				"legendary_Орк шаман": 100
			}
		},
		"ancestral_wisdom": {
			"name": "Мудрость предков",
			"description": "Увеличивает магический урон и мудрость",
			"rarity": "epic",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [30.0, 50.0, 75.0],  # +30%/+50%/+75% магический урон
			"sources": {
				"epic_Орк шаман": 100,
				"legendary_Орк шаман": 100
			}
		},
		"shaman_mastery": {
			"name": "Мастерство шамана",
			"description": "Усиливает все магические способности",
			"rarity": "legendary",
			"required_progress": [100, 500, 1000],
			"required_soul_shards": [100, 1000, 10000],
			"level_values": [35.0, 55.0, 80.0],  # +35%/+55%/+80% эффективность
			"sources": {
				"legendary_Орк шаман": 100
			}
		}
	}
	

func add_progress(enemy_type: String, enemy_rarity: String) -> Array:
	"""Добавляет прогресс изучения после победы над врагом. Возвращает список полученного прогресса."""
	var enemy_key = enemy_rarity + "_" + enemy_type
	var progress_gained = []
	
	# Определяем базовые очки на основе редкости
	var base_progress = _get_progress_by_rarity(enemy_rarity)
	
	for ability_id in ability_learning_config:
		var config = ability_learning_config[ability_id]
		if enemy_key in config.sources:
			# Используем рассчитанный прогресс на основе редкости
			var progress_gain = base_progress
			_add_ability_progress(ability_id, progress_gain)
			# Добавляем информацию о полученном прогрессе
			progress_gained.append({
				"ability_name": config.name,
				"progress": progress_gain
			})
	
	return progress_gained

func _get_progress_by_rarity(rarity: String) -> int:
	"""Возвращает количество очков прогресса на основе редкости врага"""
	var base_rarity = rarity.to_lower()
	var is_elite = false
	
	# Проверяем, является ли враг элитным
	if base_rarity.begins_with("elite_"):
		is_elite = true
		base_rarity = base_rarity.substr(6)  # Убираем "elite_"
	
	# Определяем базовые очки
	var base_points = 0
	match base_rarity:
		"common":
			base_points = 10
		"uncommon":
			base_points = 20
		"rare":
			base_points = 30
		"epic":
			base_points = 40
		"legendary":
			base_points = 50
		"mythic":
			base_points = 100
		_:
			base_points = 10  # По умолчанию как Common
	
	# Элитные враги дают ×2 прогресса
	if is_elite:
		base_points *= 2
	
	return base_points
	

func _add_ability_progress(ability_id: String, progress_gain: int):
	"""Внутренняя функция для добавления прогресса к способности"""
	if ability_id in ability_learning_config:
		if not ability_id in learning_progress:
			learning_progress[ability_id] = {
				"current_progress": 0,
				"current_level": 0,
				"is_learned": false,
				"learned_at": ""
			}
		
		var progress = learning_progress[ability_id]
		var config = ability_learning_config[ability_id]
		var current_level = progress.get("current_level", 0)
		
		# Добавляем прогресс
		progress.current_progress += progress_gain
		
		# Ограничиваем прогресс в зависимости от изученного уровня
		# Прогресс не должен накапливаться выше требований следующего неизученного уровня
		if config.required_progress is Array:
			var max_progress = 0
			if current_level == 0:
				# Если ничего не изучено, можем копить только до 1 уровня
				max_progress = config.required_progress[0]
			elif current_level == 1:
				# Если изучен 1 уровень, можем копить до 2 уровня
				max_progress = config.required_progress[1] if config.required_progress.size() > 1 else config.required_progress[0]
			elif current_level == 2:
				# Если изучен 2 уровень, можем копить до 3 уровня
				max_progress = config.required_progress[2] if config.required_progress.size() > 2 else config.required_progress[1]
			else:
				# Если изучены все уровни, прогресс не копится
				max_progress = 0
			
			# Ограничиваем прогресс максимумом
			if max_progress > 0 and progress.current_progress > max_progress:
				progress.current_progress = max_progress
		
		# Отправляем сигнал об обновлении прогресса
		progress_updated.emit(ability_id, progress.current_progress)
		
		# Сохраняем прогресс
		_save_progress()

func add_progress_for_ability(ability_display_name: String, progress_gain: int) -> Dictionary:
	"""Добавляет прогресс к конкретной способности (для элитных врагов). Возвращает информацию о прогрессе."""
	var ability_id = _get_ability_id_by_display_name(ability_display_name)
	if ability_id != "":
		_add_ability_progress(ability_id, progress_gain)
		return {
			"ability_name": ability_display_name,
			"progress": progress_gain
		}
	else:
		print("ОШИБКА: Не найден ID для способности: ", ability_display_name)
		return {}

func _get_ability_id_by_display_name(display_name: String) -> String:
	"""Преобразует отображаемое имя способности в её ID"""
	for ability_id in ability_learning_config:
		var config = ability_learning_config[ability_id]
		if config.name == display_name:
			return ability_id
	return ""


func _calculate_level(current_progress: int, required_progress) -> int:
	"""Вычисляет максимальный доступный уровень способности на основе прогресса"""
	if required_progress is Array:
		# Система уровней - определяем максимальный уровень, который можно изучить
		# Проверяем каждый уровень отдельно
		for i in range(required_progress.size()):
			if current_progress >= required_progress[i]:
				return i + 1
		return 0
	else:
		# Старая система (без уровней)
		return 1 if current_progress >= required_progress else 0

func get_ability_progress(ability_id: String) -> Dictionary:
	"""Возвращает прогресс изучения способности"""
	if ability_id in learning_progress:
		var progress = learning_progress[ability_id]
		return progress
	return {
		"current_progress": 0,
		"current_level": 0,
		"is_learned": false,
		"learned_at": null,
		"sources": {}
	}

func get_ability_level(ability_id: String) -> int:
	"""Возвращает текущий уровень способности"""
	var progress = get_ability_progress(ability_id)
	return progress.get("current_level", 0)

func can_learn_ability(ability_id: String, level: int) -> Dictionary:
	"""Проверяет, можно ли изучить способность определенного уровня"""
	var result = {
		"can_learn": false,
		"reason": "",
		"required_progress": 0,
		"required_soul_shards": 0,
		"current_progress": 0,
		"current_soul_shards": 0
	}
	
	if not ability_id in ability_learning_config:
		result.reason = "Способность не найдена"
		return result
	
	var config = ability_learning_config[ability_id]
	var progress = get_ability_progress(ability_id)
	
	if level < 1 or level > 3:
		result.reason = "Неверный уровень"
		return result
	
	# Проверяем, что предыдущий уровень изучен (если это не первый уровень)
	if level > 1:
		var current_level = progress.get("current_level", 0)
		if current_level < level - 1:
			result.reason = "Требуется изучить предыдущий уровень"
			return result
	
	var required_progress = 0
	var required_soul_shards = 0
	
	if config.required_progress is Array:
		required_progress = config.required_progress[level - 1] if level <= config.required_progress.size() else config.required_progress[-1]
	else:
		required_progress = config.required_progress
	
	if "required_soul_shards" in config:
		if config.required_soul_shards is Array:
			required_soul_shards = config.required_soul_shards[level - 1] if level <= config.required_soul_shards.size() else config.required_soul_shards[-1]
		else:
			required_soul_shards = config.required_soul_shards
	else:
		# Значения по умолчанию для осколков душ
		match level:
			1: required_soul_shards = 100
			2: required_soul_shards = 1000
			3: required_soul_shards = 10000
			_: required_soul_shards = 100
	
	result.required_progress = required_progress
	result.required_soul_shards = required_soul_shards
	
	# Вычисляем доступный прогресс для этого уровня
	# progress.current_progress уже содержит оставшийся прогресс после изучения предыдущих уровней
	var available_progress = progress.current_progress
	
	result.current_progress = available_progress
	result.current_soul_shards = get_node("/root/SoulShard").soul_shards
	
	if available_progress < required_progress:
		result.reason = "Недостаточно прогресса"
		return result
	
	if get_node("/root/SoulShard").soul_shards < required_soul_shards:
		result.reason = "Недостаточно осколков душ"
		return result
	
	result.can_learn = true
	result.reason = "Можно изучить"
	return result

func learn_ability(ability_id: String, level: int) -> bool:
	"""Изучает способность определенного уровня"""
	if not ability_id in ability_learning_config:
		return false
	
	var config = ability_learning_config[ability_id]
	var progress = learning_progress.get(ability_id, {
		"current_progress": 0,
		"current_level": 0,
		"is_learned": false,
		"learned_at": ""
	})
	
	# Проверяем, что уровень доступен для изучения
	if level < 1 or level > 3:
		return false
	
	# Проверяем, что предыдущий уровень изучен (если это не первый уровень)
	if level > 1:
		var current_level = progress.get("current_level", 0)
		if current_level < level - 1:
			print("Ошибка: Нельзя изучить уровень %d без изучения предыдущего уровня (текущий уровень: %d)" % [level, current_level])
			return false
	
	# Проверяем требования прогресса
	var required_progress = 0
	if config.required_progress is Array:
		required_progress = config.required_progress[level - 1] if level <= config.required_progress.size() else config.required_progress[-1]
	else:
		required_progress = config.required_progress
	
	# Проверяем, достаточно ли прогресса для изучения этого уровня
	if progress.current_progress < required_progress:
		return false
	
	# Проверяем требования осколков душ
	var required_soul_shards = 0
	if "required_soul_shards" in config:
		if config.required_soul_shards is Array:
			required_soul_shards = config.required_soul_shards[level - 1] if level <= config.required_soul_shards.size() else config.required_soul_shards[-1]
		else:
			required_soul_shards = config.required_soul_shards
	else:
		# Значения по умолчанию
		match level:
			1: required_soul_shards = 100
			2: required_soul_shards = 1000
			3: required_soul_shards = 10000
			_: required_soul_shards = 100
	
	var soul_shard_manager = get_node("/root/SoulShard")
	
	# Изучаем способность
	progress.current_level = level
	progress.is_learned = true
	progress.learned_at = Time.get_datetime_string_from_system()
	
	# Списываем осколки душ (функция сама проверяет достаточность)
	if not soul_shard_manager.spend_soul_shards(required_soul_shards):
		return false
	
	# Списываем прогресс (только за этот уровень)
	progress.current_progress -= required_progress
	
	learning_progress[ability_id] = progress
	
	
	# Отправляем сигнал
	ability_learned.emit(ability_id, progress.current_progress)
	
	# Сохраняем прогресс
	_save_progress()
	
	return true

func is_ability_learned(ability_id: String) -> bool:
	"""Проверяет, изучена ли способность"""
	var progress = get_ability_progress(ability_id)
	return progress.get("is_learned", false)

func get_all_progress() -> Dictionary:
	"""Возвращает весь прогресс изучения"""
	return learning_progress

func get_learned_abilities() -> Array[String]:
	"""Возвращает список изученных способностей"""
	var learned: Array[String] = []
	for ability_id in learning_progress:
		if learning_progress[ability_id].is_learned:
			learned.append(ability_id)
	return learned

func learn_ability_instantly(ability_id: String) -> bool:
	"""Мгновенно изучает способность (для покупки за осколки душ)"""
	if not ability_id in ability_learning_config:
		print("Ошибка: способность не найдена в конфигурации: ", ability_id)
		return false
	
	# Устанавливаем способность как изученную
	if not ability_id in learning_progress:
		learning_progress[ability_id] = {
			"current_progress": 0,
			"is_learned": false,
			"learned_at": null,
			"sources": {}
		}
	
	var progress = learning_progress[ability_id]
	
	# Инициализируем current_level если его нет
	if not "current_level" in progress:
		progress.current_level = 0
	
	# Определяем, какой уровень можно изучить
	var required_progress = ability_learning_config[ability_id].required_progress
	var available_level = _calculate_level(progress.current_progress, required_progress)
	
	if available_level > 0:
		# Изучаем доступный уровень
		progress.current_level = available_level
		progress.is_learned = true
		progress.learned_at = Time.get_datetime_string_from_system()
		
		# Списываем прогресс только за новый уровень (не за все уровни)
		# Если current_level был 0, то изучаем уровень 1
		# Если current_level был 1, то изучаем уровень 2, и т.д.
		var new_level = available_level
		var current_level = progress.get("current_level", 0)
		
		# Списываем прогресс только за новый уровень
		if new_level > current_level and new_level <= required_progress.size():
			var cost_for_new_level = required_progress[new_level - 1]
			progress.current_progress -= cost_for_new_level
		
		# Отправляем сигнал
		ability_learned.emit(ability_id, progress.current_progress)
	else:
		return false
	
	# Сохраняем прогресс
	_save_progress()
	
	return true

func reset_learning_progress():
	"""Сбрасывает весь прогресс изучения способностей"""
	learning_progress = {}
	_save_progress()
	
	# Пересчитываем бонусы духовной мощи и других улучшений души
	var soul_restoration_manager = get_node_or_null("/root/SoulRestorationManager")
	if soul_restoration_manager and soul_restoration_manager.has_method("recalculate_bonuses_from_learned_abilities"):
		soul_restoration_manager.recalculate_bonuses_from_learned_abilities()
		print("Бонусы развития души пересчитаны после сброса")

func has_any_progress() -> bool:
	"""Проверяет, есть ли какой-либо прогресс изучения"""
	return learning_progress.size() > 0

func _save_progress():
	"""Сохраняет прогресс изучения"""
	var save_data = {
		"learning_progress": learning_progress,
		"last_updated": Time.get_datetime_string_from_system()
	}
	
	# Сохраняем в файл
	var save_file = FileAccess.open("user://ability_learning_progress.save", FileAccess.WRITE)
	if save_file:
		save_file.store_string(JSON.stringify(save_data))
		save_file.close()
	else:
		print("Ошибка сохранения прогресса изучения")

func _load_progress():
	"""Загружает прогресс изучения"""
	if FileAccess.file_exists("user://ability_learning_progress.save"):
		var save_file = FileAccess.open("user://ability_learning_progress.save", FileAccess.READ)
		if save_file:
			var json_string = save_file.get_as_text()
			save_file.close()
			
			var json = JSON.new()
			var parse_result = json.parse(json_string)
			
			if parse_result == OK:
				var save_data = json.data
				learning_progress = save_data.get("learning_progress", {})
				_migrate_old_saves()  # Мигрируем старые сохранения
				_save_progress()  # Сохраняем исправленные данные после миграции
			else:
				print("Ошибка парсинга сохранения прогресса")
	else:
		print("Файл прогресса изучения не найден, создаем новый")
		learning_progress = {}

func _force_fix_ability_levels():
	"""ПРИНУДИТЕЛЬНО исправляет уровни способностей на основе is_learned флага"""
	print("=== ПРИНУДИТЕЛЬНОЕ ИСПРАВЛЕНИЕ УРОВНЕЙ СПОСОБНОСТЕЙ ===")
	var fixed_count = 0
	
	for ability_id in learning_progress:
		var progress = learning_progress[ability_id]
		var is_learned = progress.get("is_learned", false)
		var current_level = progress.get("current_level", 0)
		
		# Если способность НЕ изучена (is_learned = false), но current_level > 0
		# ЭТО ОШИБКА! Сбрасываем current_level в 0
		if not is_learned and current_level > 0:
			print("ИСПРАВЛЕНИЕ: '", ability_id, "' НЕ изучена, но current_level = ", current_level, " -> сброс в 0")
			progress.current_level = 0
			fixed_count += 1
		
		# Ограничиваем прогресс в соответствии с реальным уровнем
		if ability_id in ability_learning_config:
			var required_progress = ability_learning_config[ability_id].required_progress
			if required_progress is Array:
				var real_level = progress.get("current_level", 0)
				var max_progress = 0
				
				if real_level == 0:
					max_progress = required_progress[0]  # 100
				elif real_level == 1:
					max_progress = required_progress[1] if required_progress.size() > 1 else required_progress[0]  # 500
				elif real_level == 2:
					max_progress = required_progress[2] if required_progress.size() > 2 else required_progress[1]  # 1000
				elif real_level >= 3:
					max_progress = required_progress[2] if required_progress.size() > 2 else required_progress[-1]
				
				if max_progress > 0 and progress.current_progress > max_progress:
					print("ИСПРАВЛЕНИЕ: '", ability_id, "' прогресс ", progress.current_progress, " -> ", max_progress, " (уровень: ", real_level, ")")
					progress.current_progress = max_progress
					fixed_count += 1
	
	if fixed_count > 0:
		print("=== ИСПРАВЛЕНО ", fixed_count, " СПОСОБНОСТЕЙ ===")
		_save_progress()  # Сохраняем исправленные данные
	else:
		print("=== ВСЕ СПОСОБНОСТИ В ПОРЯДКЕ ===")

func _migrate_old_saves():
	"""Мигрирует старые сохранения для поддержки системы уровней"""
	for ability_id in learning_progress:
		var progress = learning_progress[ability_id]
		
		# Добавляем current_level если его нет
		if not "current_level" in progress:
			progress.current_level = 0
		
		# Если способность изучена (старый формат), но нет уровня, устанавливаем уровень 1
		if progress.get("is_learned", false) and progress.current_level == 0:
			progress.current_level = 1
		
		# ОГРАНИЧИВАЕМ ПРОГРЕСС В СООТВЕТСТВИИ С ИЗУЧЕННЫМ УРОВНЕМ
		# Прогресс не должен накапливаться выше требований следующего неизученного уровня
		if ability_id in ability_learning_config:
			var required_progress = ability_learning_config[ability_id].required_progress
			# Прогресс не должен накапливаться выше требований следующего неизученного уровня
			if required_progress is Array:
				var current_level = progress.get("current_level", 0)
				var max_progress = 0
				
				if current_level == 0:
					# Если ничего не изучено, можем копить только до 1 уровня
					max_progress = required_progress[0]
				elif current_level == 1:
					# Если изучен 1 уровень, можем копить до 2 уровня
					max_progress = required_progress[1] if required_progress.size() > 1 else required_progress[0]
				elif current_level == 2:
					# Если изучен 2 уровень, можем копить до 3 уровня
					max_progress = required_progress[2] if required_progress.size() > 2 else required_progress[1]
				elif current_level >= 3:
					# Если изучены все уровни, прогресс сбрасываем до требований последнего уровня
					max_progress = required_progress[2] if required_progress.size() > 2 else required_progress[-1]
				
				# Ограничиваем прогресс максимумом
				if max_progress > 0 and progress.current_progress > max_progress:
					print("МИГРАЦИЯ: Ограничиваем прогресс для '", ability_id, "' с ", progress.current_progress, " до ", max_progress, " (текущий уровень: ", current_level, ")")
					progress.current_progress = max_progress

func set_ability_learned(ability_id: String):
	"""Устанавливает способность как изученную (для способностей развития души)"""
	if not ability_id in learning_progress:
		learning_progress[ability_id] = {
			"current_progress": 0,
			"current_level": 0,
			"is_learned": false,
			"learned_at": null,
			"sources": {}
		}
	
	var progress = learning_progress[ability_id]
	progress.current_level = 1
	progress.is_learned = true
	progress.learned_at = Time.get_datetime_string_from_system()
	
	# Сохраняем прогресс
	_save_progress()
	
	# Отправляем сигнал
	ability_learned.emit(ability_id, 0)
	
	print("✅ Способность развития души отмечена как изученная: ", ability_id)
	
	# Пересчитываем бонусы духовной мощи и других улучшений души
	var soul_restoration_manager = get_node_or_null("/root/SoulRestorationManager")
	if soul_restoration_manager and soul_restoration_manager.has_method("recalculate_bonuses_from_learned_abilities"):
		soul_restoration_manager.recalculate_bonuses_from_learned_abilities()
		print("Бонусы развития души пересчитаны после изучения способности")
