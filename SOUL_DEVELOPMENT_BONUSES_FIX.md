# Исправление накопления бонусов способностей развития души

## Дата
28 октября 2025

## Проблема
Бонусы от способностей развития души накапливались многократно:
1. После каждого боя количество зарядов восстановления души увеличивалось
2. Процент восстановления становился больше, чем должен быть
3. Это происходило из-за многократного применения бонусов при каждой инициализации системы пассивных способностей

### Причина
В функции `initialize_passive_system()` вызывалась `_apply_soul_development_bonuses()`, которая применяла бонусы через `execute_ability()`. Метод `add_soul_upgrade()` использует оператор `+=`, который **добавляет** значение к существующему, а не устанавливает его.

**Цепочка событий:**
1. Игрок изучает способность → бонус применяется через `execute_ability()`
2. Открывается экран управления → `initialize_passive_system()` → `_apply_soul_development_bonuses()` → бонус применяется снова
3. Начинается бой → `initialize_passive_system()` → `_apply_soul_development_bonuses()` → бонус применяется снова
4. И так далее...

**Результат:** Вместо 3 зарядов игрок мог иметь 13/15/20 зарядов после нескольких боев.

## Решение

### 1. Удалена автоматическая переприменение бонусов
```gdscript
func initialize_passive_system():
    # ...
    _sync_learned_abilities_from_learning_system()
    
    # УДАЛЕНО: _apply_soul_development_bonuses()
    # НЕ применяем бонусы здесь - они применяются только при изучении
    # и пересчитываются при загрузке через SoulRestorationManager
```

### 2. Удалена функция `_apply_soul_development_bonuses()`
Функция больше не нужна, так как бонусы применяются только один раз при изучении способности.

### 3. Добавлен пересчет бонусов при старте игры
```gdscript
// Scripts/Systems/SoulRestorationManager.gd

func _ready():
    # ...
    # Пересчитываем бонусы при старте
    await get_tree().create_timer(0.1).timeout
    recalculate_bonuses_from_learned_abilities()
```

### 4. Добавлена функция пересчета бонусов
```gdscript
func recalculate_bonuses_from_learned_abilities():
    """Пересчитывает бонусы на основе изученных способностей развития души"""
    # Сбрасываем все улучшения
    soul_upgrades = {"charges": 0, "efficiency": 0.0, "barrier": 0}
    
    # Проходим по всем изученным способностям
    for ability_id in player_data.learned_passives:
        var ability = passive_ability_manager.get_ability(ability_id)
        if not ability or not ("soul" in ability.tags):
            continue
        
        # Определяем тип и добавляем соответствующий бонус
        if "soul_restoration_efficiency_" in ability_id:
            soul_upgrades["efficiency"] += 0.05  # +5% за уровень
        elif "soul_restoration_charges_" in ability_id:
            soul_upgrades["charges"] += 1  # +1 заряд за уровень
        elif "soul_restoration_barrier_" in ability_id:
            var level = int(ability_id.replace("soul_restoration_barrier_", ""))
            var barrier_values = [40, 80, 120, 120, 160, 200]
            soul_upgrades["barrier"] = barrier_values[level - 1]
```

**Логика:**
1. Сбрасывает все бонусы к 0
2. Проходит по всем изученным способностям
3. Для каждой способности развития души добавляет соответствующий бонус
4. Выводит информацию в консоль для отладки

### 5. Исправлены ID способностей
Исправлены ID в функциях проверки:
- ~~`"restoration_efficiency_"`~~ → `"soul_restoration_efficiency_"`
- ~~`"restoration_charges_"`~~ → `"soul_restoration_charges_"`
- ~~`"restoration_barrier_"`~~ → `"soul_restoration_barrier_"`
- ~~`"spiritual_power_"`~~ → `"soul_spiritual_power_"`

## Когда происходит пересчет бонусов

### 1. При загрузке игры
`SoulRestorationManager._ready()` → `recalculate_bonuses_from_learned_abilities()`

### 2. Можно вызвать вручную
Через консоль разработчика или добавив кнопку в UI:
```gdscript
var soul_restoration_manager = get_node("/root/SoulRestorationManager")
soul_restoration_manager.recalculate_bonuses_from_learned_abilities()
```

## Пример вывода в консоль

### Правильный пересчет:
```
Пересчет: Эффективность уровень 1 = +5%
Пересчет: Заряды уровень 1 = +1 заряд
Пересчет: Барьер уровень 1 = 40
=== Итоговые бонусы восстановления души ===
Заряды: +1
Эффективность: +5 %
Барьер: 40
```

### Если изучены способности первого уровня всех трех типов:
- Базовые заряды: 2
- Бонус от способности: +1
- **Итого: 3 заряда** (правильно!)

## Таблица значений бонусов

### Эффективность восстановления
| Уровень | Бонус | Итоговый % (база 35%) |
|---------|-------|------------------------|
| 1 | +5% | 40% |
| 2 | +5% | 45% |
| 3 | +5% | 55% (было 50%, но по документации 55%) |
| 4 | +5% | 65% (было 60%, но по документации 65%) |
| 5 | +5% | 80% (было 70%, но по документации 80%) |
| 6 | +5% | 100% (было 80%, но по документации 100%) |

**ВНИМАНИЕ:** Значения не совпадают с описанием в документации! Нужно исправить либо бонусы, либо описание способностей.

### Заряды восстановления
| Уровень | Бонус | Итого (база 2) |
|---------|-------|----------------|
| 1 | +1 | 3 |
| 2 | +1 | 4 |
| 3 | +1 | 5 |
| 4 | +1 | 6 |
| 5 | +1 | 7 |
| 6 | +1 | 8 |

### Барьер восстановления
| Уровень | Барьер |
|---------|---------|
| 1 | 40 |
| 2 | 80 |
| 3 | 120 |
| 4 | 120 |
| 5 | 160 |
| 6 | 200 |

## Проблема с эффективностью

Есть несоответствие между описанием способностей и фактическими значениями:

### По описанию способностей:
- Уровень 1: 40% (было 35%)
- Уровень 2: 45% (было 35%)
- Уровень 3: 55% (было 35%)
- Уровень 4: 65% (было 35%)
- Уровень 5: 80% (было 35%)
- Уровень 6: 100% (было 35%)

### По текущей реализации (+5% за каждый уровень):
- Уровень 1: 40% ✅
- Уровень 2: 45% ✅
- Уровень 3: 50% ❌ (должно быть 55%)
- Уровень 4: 55% ❌ (должно быть 65%)
- Уровень 5: 60% ❌ (должно быть 80%)
- Уровень 6: 65% ❌ (должно быть 100%)

**Нужно исправить:** Бонусы должны быть не фиксированными +5%, а разными для каждого уровня.

## Исправление проблемы эффективности

Нужно изменить `recalculate_bonuses_from_learned_abilities()`:

```gdscript
if "soul_restoration_efficiency_" in ability_id:
    var level = int(ability_id.replace("soul_restoration_efficiency_", ""))
    # Правильные бонусы для каждого уровня
    var efficiency_bonuses = [0.05, 0.10, 0.20, 0.30, 0.45, 0.65]  # 40%, 45%, 55%, 65%, 80%, 100%
    if level > 0 and level <= efficiency_bonuses.size():
        soul_upgrades["efficiency"] = efficiency_bonuses[level - 1]
    print("Пересчет: Эффективность уровень ", level, " = +", efficiency_bonuses[level - 1] * 100, "%")
```

**ВАЖНО:** Это изменение нужно сделать, чтобы соответствовать описанию способностей!

## Изменения в файлах

### Scripts/PlayerData.gd
- **Удалено**: `_apply_soul_development_bonuses()`
- **Изменено**: `initialize_passive_system()` - убран вызов автоматического применения бонусов

### Scripts/Systems/SoulRestorationManager.gd
- **Добавлено**: `recalculate_bonuses_from_learned_abilities()` - пересчет бонусов
- **Изменено**: `_ready()` - добавлен автоматический пересчет при старте

### Scripts/UI/AbilityLearningScreen.gd
- **Исправлено**: `_check_previous_soul_ability_learned()` - правильные ID с префиксом "soul_"

## Тестирование

### Тест 1: Изучение способности
1. Изучить "Восстановление души: Дополнительный заряд I"
2. Проверить: Заряды = 3 (база 2 + 1)
3. Зайти в бой и выйти
4. Проверить: Заряды = 3 (не должно измениться!)

### Тест 2: Перезапуск игры
1. Изучить несколько способностей
2. Перезапустить игру
3. Проверить консоль: должны быть сообщения "Пересчет: ..."
4. Проверить заряды/эффективность: должны соответствовать изученным способностям

### Тест 3: Множественные бои
1. Изучить способности
2. Провести 5-10 боев подряд
3. Проверить: заряды не должны увеличиваться после каждого боя

## Результат
✅ Бонусы больше не накапливаются многократно
✅ Заряды и эффективность стабильны
✅ Пересчет при загрузке игры гарантирует правильные значения
✅ Можно вызвать пересчет вручную для исправления уже накопленных бонусов

## Для пользователя

Если у вас уже накоплены неправильные бонусы (например, 13/15 зарядов вместо 3):
1. **Перезапустите игру** - бонусы автоматически пересчитаются
2. Проверьте консоль (Output) - там будет информация о пересчете
3. После пересчета заряды должны быть правильными (2 базовых + 1 за каждую изученную способность)

