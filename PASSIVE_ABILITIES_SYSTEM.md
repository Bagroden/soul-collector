# Система пассивных способностей игрока

## Обзор

Система пассивных способностей позволяет игроку изучать, активировать и деактивировать различные пассивные способности, которые дают постоянные бонусы в бою. Каждая пассивная способность имеет **три уровня прокачки**, что позволяет постепенно улучшать их эффективность.

## Компоненты системы

### 1. PlayerData (Scripts/PlayerData.gd)
- **learned_passives**: Array[String] - изученные пассивные способности
- **active_passives**: Array[String] - активные пассивные способности
- **passive_ability_levels**: Dictionary - уровни изученных пассивных способностей
- **passive_ability_manager**: PassiveAbilityManager - менеджер пассивных способностей

### 2. PassiveAbilitiesWindow (Scenes/UI/PassiveAbilitiesWindow.tscn)
- Окно для управления пассивными способностями
- Отображает активные и доступные способности
- Позволяет активировать/деактивировать способности

### 3. Пассивные способности игрока (Scripts/PassiveAbilities/Player/)
- **PlayerDodge.gd** - Уворот (10%/17%/30% шанс увернуться от атаки)
- **PlayerStrength.gd** - Сила воина (+15%/+25%/+40% к физическому урону)
- **PlayerVitality.gd** - Живучесть (+30/+60/+100 HP)
- **PlayerCrit.gd** - Критический удар (+8%/+15%/+25% к шансу крита)

## Система уровней пассивных способностей

### Уровни способностей
Каждая пассивная способность имеет **три уровня прокачки**:

#### Пример: Уворот (Dodge)
- **1 уровень**: 10% шанс увернуться от атаки
- **2 уровень**: 17% шанс увернуться от атаки  
- **3 уровень**: 30% шанс увернуться от атаки

### Прогрессия изучения
Шкала прогресса заполняется **три раза** для каждой способности:

#### Очки прогресса за победу над врагами:
- **Враг с 1 уровнем способности**: +10 очков прогресса
- **Враг со 2 уровнем способности**: +30 очков прогресса
- **Враг с 3 уровнем способности**: +50 очков прогресса

#### Требования для изучения уровней:
- **1 уровень**: 100 очков прогресса
- **2 уровень**: 500 очков прогресса
- **3 уровень**: 1000 очков прогресса

### Уровни способностей у врагов
Враги имеют разные уровни пассивных способностей в зависимости от:
- **Уровня врага** - чем выше уровень, тем выше шанс на развитые способности

#### Распределение уровней:
- **1 - 10 уровень врагов**: преимущественно 1 уровень способностей
- **11 - 20 уровень врагов**: смесь 1-2 уровней способностей
- **21 - 30 уровень врагов**: преимущественно 2-3 уровни способностей
- **Уникальный и элитные враги**: На любых уровнях могут иметь развитые способности

## Как использовать

### 1. Изучение пассивных способностей
```gdscript
var player_data = PlayerManager.get_player_data()
player_data.initialize_passive_system()

# Изучение способности (автоматически 1 уровень)
player_data.learn_passive_ability("player_dodge")

# Повышение уровня способности
player_data.upgrade_passive_ability("player_dodge", 2)  # до 2 уровня
player_data.upgrade_passive_ability("player_dodge", 3)  # до 3 уровня
```

### 2. Активация/деактивация способностей
```gdscript
# Активация
player_data.activate_passive_ability("player_dodge")

# Деактивация
player_data.deactivate_passive_ability("player_dodge")

# Переключение
player_data.toggle_passive_ability("player_dodge")
```

### 3. Проверка состояния способностей
```gdscript
# Проверить, изучена ли способность
var is_learned = player_data.has_learned_passive("player_dodge")

# Проверить, активна ли способность
var is_active = player_data.has_active_passive("player_dodge")

# Получить уровень способности
var level = player_data.get_passive_ability_level("player_dodge")

# Получить список активных способностей
var active_passives = player_data.get_active_passives()
```

## Интеграция с боевой системой

### Автоматическое применение в бою
Пассивные способности автоматически применяются к игроку в начале каждого боя через `battle_manager.gd`:

```gdscript
func _apply_player_passive_abilities():
    # Получаем активные способности
    var active_passives = player_data.get_active_passives()
    
    # Применяем каждую способность
    for ability_id in active_passives:
        var ability = player_data.get_passive_ability_info(ability_id)
        player_node.add_passive_ability(ability)
```

### Эффекты в бою (по уровням)
- **PlayerDodge**: 10%/17%/30% шанс увернуться от атаки
- **PlayerStrength**: +15%/+25%/+40% к физическому урону
- **PlayerVitality**: +30/+60/+100 к максимальному HP
- **PlayerCrit**: +8%/+15%/+25% к шансу критического удара

## Тестирование

### Главная тестовая сцена
`Scenes/UI/MainPassiveTest.tscn` - основная сцена для тестирования системы

### Функции тестирования
1. **Изучение способностей** - изучает базовые пассивные способности
2. **Открытие окна** - показывает окно управления пассивными способностями
3. **Тест активации** - тестирует активацию/деактивацию способностей
4. **Тест в бою** - запускает бой для проверки применения способностей

## Сохранение и загрузка

Система автоматически сохраняет и загружает:
- Изученные пассивные способности (`learned_passives`)
- Активные пассивные способности (`active_passives`)
- Уровни пассивных способностей (`passive_ability_levels`)
- Прогресс изучения способностей (через `AbilityLearningSystem`)

## Расширение системы

### Добавление новых пассивных способностей
1. Создайте новый файл в `Scripts/PassiveAbilities/Player/`
2. Наследуйтесь от `PassiveAbility`
3. Реализуйте метод `execute_ability`
4. Добавьте загрузку в `PassiveAbilityManager._load_player_abilities()`
5. Добавьте обработку в `body.gd._apply_passive_effects()`

### Пример новой способности
```gdscript
# res://Scripts/PassiveAbilities/Player/PlayerMagic.gd
extends PassiveAbility

func _init():
    id = "player_magic"
    name = "Магическая сила"
    description = "Увеличивает магический урон на 20%/35%/55%"
    rarity = "rare"
    ability_type = AbilityType.OFFENSIVE
    trigger_type = TriggerType.PASSIVE
    # Значения для каждого уровня
    level_values = [20.0, 35.0, 55.0]
    value = level_values[0]  # Значение по умолчанию (1 уровень)

func execute_ability(_owner: Node, _target: Node = null, _context: Dictionary = {}) -> Dictionary:
    # Получаем текущий уровень способности
    var current_level = _context.get("level", 1)
    var current_value = level_values[current_level - 1]
    
    return {
        "success": true,
        "message": "Магическая сила активна!",
        "magic_bonus": current_value
    }
```

## Система прогрессии изучения

### AbilityLearningSystem
Система отслеживает прогресс изучения каждой пассивной способности:

```gdscript
# Получение прогресса изучения
var progress = AbilityLearningSystem.get_ability_progress("player_dodge")
print("Прогресс изучения уворота: ", progress.current, "/", progress.required)

# Добавление прогресса за победу над врагом
AbilityLearningSystem.add_ability_progress("player_dodge", 30)  # +30 очков

# Проверка готовности к изучению
if AbilityLearningSystem.can_learn_ability("player_dodge"):
    player_data.learn_passive_ability("player_dodge")
```

### Требования для изучения уровней
- **1 уровень**: 100 очков прогресса
- **2 уровень**: 500 очков прогресса (всего 600)
- **3 уровень**: 1000 очков прогресса (всего 1600)

### Очки прогресса за врагов
- **Враг с 1 уровнем способности**: +10 очков
- **Враг со 2 уровнем способности**: +30 очков
- **Враг с 3 уровнем способности**: +50 очков

## Цветовая схема редкости

- **common** (обычная) - Белый
- **uncommon** (необычная) - Зеленый
- **rare** (редкая) - Синий
- **epic** (эпическая) - Фиолетовый
- **legendary** (легендарная) - Оранжевый
- **mythic** (мифическая) - Красный

## Заключение

Система пассивных способностей с тремя уровнями прокачки полностью интегрирована с игрой и готова к использованию. Она обеспечивает:

- **Гибкую систему прогрессии** - игроки могут постепенно улучшать свои способности
- **Стратегическую глубину** - выбор между изучением новых способностей или улучшением существующих
- **Мотивацию для исследования** - поиск сильных врагов с развитыми способностями
- **Балансированный геймплей** - постепенное увеличение сложности и наград

Система добавляет значительную глубину геймплею и создает долгосрочные цели для игроков.
