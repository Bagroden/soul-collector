# Система Духовной мощи

## Описание
Система Духовной мощи (Spiritual Power) ограничивает количество пассивных способностей, которые игрок может активировать одновременно.

## Основные параметры

### Духовная мощь игрока
- **Начальное значение**: 5 единиц на 1 уровне
- **Прирост**: +1 единица за каждый уровень
- **Формула**: `5 + (уровень - 1)`

### Примеры по уровням:
- Уровень 1: 5 духовной мощи
- Уровень 5: 9 духовной мощи
- Уровень 7: 12 духовной мощи
- Уровень 10: 15 духовной мощи
- Уровень 20: 25 духовной мощи

## Стоимость способностей по редкости

Каждая пассивная способность требует определенное количество духовной мощи в зависимости от редкости:

| Редкость    | Стоимость (ДМ) |
|-------------|----------------|
| Common      | 3              |
| Uncommon    | 5              |
| Rare        | 7              |
| Epic        | 9              |
| Legendary   | 12             |
| Mythic      | 15             |

## Примеры комбинаций

### Уровень 7 (12 духовной мощи):
- 4 × Common (4 × 3 = 12)
- 2 × Uncommon + 2 × Common (2 × 5 + 2 × 3 = 16) - не хватает!
- 2 × Uncommon + 1 × Common (2 × 5 + 1 × 3 = 13) - не хватает!
- 1 × Uncommon + 2 × Common (1 × 5 + 2 × 3 = 11) ✓
- 1 × Rare + 1 × Uncommon (1 × 7 + 1 × 5 = 12) ✓
- 1 × Legendary (1 × 12 = 12) ✓

### Уровень 15 (20 духовной мощи):
- 6 × Common (6 × 3 = 18) ✓
- 4 × Uncommon (4 × 5 = 20) ✓
- 2 × Rare + 1 × Uncommon + 1 × Common (2 × 7 + 1 × 5 + 1 × 3 = 22) - не хватает!
- 2 × Rare + 2 × Common (2 × 7 + 2 × 3 = 20) ✓
- 1 × Legendary + 1 × Rare + 1 × Common (1 × 12 + 1 × 7 + 1 × 3 = 22) - не хватает!
- 1 × Legendary + 1 × Uncommon + 1 × Common (1 × 12 + 1 × 5 + 1 × 3 = 20) ✓
- 1 × Mythic + 1 × Uncommon (1 × 15 + 1 × 5 = 20) ✓

## Реализация

### PlayerData.gd
```gdscript
# Духовная мощь
var spiritual_power: int = 5  # Доступная духовная мощь
var max_spiritual_power: int = 5  # Максимальная духовная мощь
var used_spiritual_power: int = 0  # Использованная духовная мощь

# Обновление при повышении уровня
func _update_spiritual_power():
    max_spiritual_power = 5 + (level - 1)
    spiritual_power = max_spiritual_power
    _recalculate_used_spiritual_power()

# Получение стоимости способности
func get_spiritual_power_cost(rarity: String) -> int:
    match rarity:
        "common": return 3
        "uncommon": return 5
        "rare": return 7
        "epic": return 9
        "legendary": return 12
        "mythic": return 15
        _: return 3

# Проверка возможности активации
func can_activate_passive(ability_id: String) -> Dictionary:
    # Проверяет изучение, активацию и доступность духовной мощи
    # Возвращает {can_activate: bool, reason: String}
```

### Сигналы
```gdscript
signal spiritual_power_changed(current: int, max_power: int, used: int)
```

### PassiveAbilitiesWindow.gd
- Отображает текущую/максимальную/использованную духовную мощь в info_label
- Показывает стоимость каждой способности в карточках ([X ДМ])
- Проверяет лимит перед активацией способности
- Показывает сообщение об ошибке при недостатке духовной мощи

## UI отображение

### Информационная панель:
```
Активных способностей: 3 из 12 | Духовная мощь: 8 / 15 (использовано: 7)
```

### Карточка способности:
```
[Название способности (ур. 2)]  [Rare]  [7 ДМ]
Описание способности...
[АКТИВНА] / [НЕАКТИВНА]
```

## Логика активации

1. Игрок нажимает кнопку активации способности
2. Система проверяет:
   - Изучена ли способность
   - Не активирована ли уже
   - Достаточно ли духовной мощи
3. Если все проверки пройдены:
   - Способность активируется
   - Обновляется `used_spiritual_power`
   - Обновляется `spiritual_power` (доступная)
   - Испускается сигнал `spiritual_power_changed`
   - Применяются бонусы способности
4. При деактивации:
   - Способность деактивируется
   - Освобождается духовная мощь
   - Обновляются счетчики
   - Удаляются бонусы способности

## Сохранение/Загрузка

Духовная мощь сохраняется в `PlayerManager.gd`:
```gdscript
"spiritual_power": player_data.spiritual_power,
"max_spiritual_power": player_data.max_spiritual_power,
"used_spiritual_power": player_data.used_spiritual_power,
```

При загрузке старых сохранений без этих полей, значения рассчитываются автоматически на основе уровня игрока.

## Баланс

Система разработана так, чтобы:
1. Ранние уровни заставляют выбирать между несколькими слабыми или одной сильной способностью
2. На высоких уровнях игрок может активировать больше способностей, но все равно должен делать выбор
3. Мифические способности (15 ДМ) требуют минимум 15 уровня для активации
4. Игрок всегда может переключать способности, адаптируя билд под ситуацию

## Примечания

- Духовная мощь **НЕ** тратится при использовании способностей в бою
- Духовная мощь определяет только **количество активных** пассивных способностей
- Игрок может в любой момент деактивировать способности и активировать другие
- Стоимость способности не зависит от ее уровня (только от редкости)

