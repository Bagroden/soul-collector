# Система валюты для Развития души

## Обзор
Реализована система покупки способностей развития души за различные типы валюты: осколки душ, сильные души, великие души и божественные души.

## Валюты
- **Осколки душ (ОД)** - базовая валюта для всех способностей
- **Сильные души** - требуются для редких и эпических способностей
- **Великие души** - требуются для легендарных способностей
- **Божественные души** - требуются для мифических способностей

## Стоимость способностей
- **Common**: 50 ОД
- **Uncommon**: 100 ОД
- **Rare**: 150 ОД + 1 сильная душа
- **Epic**: 200 ОД + 2 сильные души
- **Legendary**: 300 ОД + 4 великие души
- **Mythic**: 500 ОД + 8 божественных душ

## Изменения в коде

### Scripts/UI/AbilityLearningScreen.gd
1. **Добавлены функции проверки и списания валюты**:
   - `_check_soul_ability_cost(rarity: String) -> bool` - проверяет достаточность валюты
   - `_spend_soul_ability_cost(rarity: String) -> bool` - списывает валюту при покупке
   - `_get_soul_ability_cost(rarity: String) -> String` - возвращает текст стоимости

2. **Обновлена функция создания карточек способностей**:
   - Добавлена проверка наличия валюты при отображении кнопки "Изучить"
   - Если валюты недостаточно, кнопка отключается с текстом "Недостаточно валюты"
   - Изученные способности отображаются с зеленым фоном и текстом "✅ Изучено"

3. **Переработана функция изучения способностей**:
   - Разделена на `_learn_soul_development_ability` и `_learn_normal_ability`
   - Способности души изучаются напрямую через валюту, без системы прогресса
   - При изучении списывается валюта, применяется бонус, и сохраняется прогресс

### Scripts/Systems/AbilityLearningSystem.gd
**Добавлен метод `set_ability_learned(ability_id: String)`**:
- Устанавливает `current_level = 1` для способности
- Помечает способность как изученную (`is_learned = true`)
- Сохраняет время изучения
- Отправляет сигнал `ability_learned`
- Сохраняет прогресс в файл

## Визуальная индикация изученных способностей

### Зеленый фон
Изученные способности развития души отображаются с:
- Зеленоватым фоном (`Color(0.2, 0.4, 0.2, 0.3)`)
- Зеленой границей (`Color(0.3, 0.6, 0.3, 0.8)`)
- Скругленными углами (радиус 8px)

### Текст "✅ Изучено"
Вместо информации о прогрессе отображается:
- Ярко-зеленый текст "✅ Изучено"
- Цвет: `Color(0.3, 1.0, 0.3)`

### Заблокированная кнопка
После изучения:
- Кнопка отключается (`disabled = true`)
- Текст кнопки: "Изучено"

## Проверка валюты
Система проверяет наличие валюты в следующих менеджерах:
- `/root/SoulShardManager` - осколки душ
- `/root/StrongSoulsManager` - сильные души
- `/root/GreatSoulsManager` - великие души
- `/root/DivineSoulsManager` - божественные души

## Процесс изучения способности

1. Пользователь нажимает кнопку "Изучить"
2. Проверяется, не изучена ли способность уже
3. Проверяется наличие достаточного количества валюты
4. Списывается валюта из соответствующих менеджеров
5. Способность отмечается как изученная в `AbilityLearningSystem` (`current_level = 1`)
6. Способность добавляется в `player_data.learned_passives`
7. Применяется бонус способности через `ability.execute_ability(player_data)`
8. Сохраняется прогресс
9. Обновляется UI
10. Показывается сообщение об успехе

## Сообщения для пользователя

### Успешное изучение
```
Заголовок: Способность изучена!
Текст: Способность '[название]' успешно изучена!

Бонус применен.
```

### Недостаточно валюты
```
Заголовок: Недостаточно валюты
Текст: Недостаточно валюты для изучения этой способности.

Требуется: [стоимость]
```

### Уже изучено
```
Заголовок: Уже изучено
Текст: Эта способность уже изучена!
```

## Сохранение и загрузка
- Изученные способности сохраняются в `user://ability_learning_progress.save`
- При загрузке игры состояние изученных способностей восстанавливается
- Метод `_migrate_old_saves()` обеспечивает совместимость со старыми сохранениями

## Совместимость
Система полностью совместима с существующей системой изучения обычных пассивных способностей. Обычные способности продолжают использовать систему прогресса и осколков душ, а способности развития души используют только прямую покупку за валюту.

