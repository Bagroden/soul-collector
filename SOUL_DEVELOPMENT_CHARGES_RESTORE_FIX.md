# Исправление восстановления текущих зарядов после пересчета

## Дата
28 октября 2025

## Проблема
После пересчета бонусов максимальное количество зарядов становилось правильным (3), но текущее количество оставалось на старом значении (2), что давало 2/3 вместо 3/3.

### Логи пользователя
```
=== Итоговые бонусы восстановления души ===
Заряды: +1
Эффективность: +5.0%
Барьер: 40
```

**Результат в игре**: 2/3 заряда
**Ожидаемо**: 3/3 заряда

### Причина
Функция `recalculate_bonuses_from_learned_abilities()` пересчитывала только бонусы (`soul_upgrades`), но не обновляла текущее количество зарядов (`current_charges`).

**Что происходило:**
1. До пересчета: `current_charges = 2`, `max_charges = 2 + old_bonus`
2. Пересчет: `soul_upgrades["charges"] = 1` (правильно!)
3. Максимум: `get_max_charges() = 2 + 1 = 3` (правильно!)
4. Текущие: `current_charges = 2` (не изменились!)
5. **Результат: 2/3** ❌

## Решение

### Добавлено восстановление текущих зарядов
После пересчета бонусов текущие заряды устанавливаются равными новому максимуму:

```gdscript
func recalculate_bonuses_from_learned_abilities():
    # ... пересчет бонусов ...
    
    print("=== Итоговые бонусы восстановления души ===")
    print("Заряды: +", soul_upgrades["charges"])
    print("Максимум зарядов: ", get_max_charges())
    print("Текущие заряды ДО восстановления: ", current_charges)
    
    # Восстанавливаем текущие заряды до нового максимума
    current_charges = get_max_charges()
    print("Текущие заряды ПОСЛЕ восстановления: ", current_charges)
    
    # Обновляем UI
    charges_changed.emit(current_charges, get_max_charges())
```

## Логика восстановления

### Когда восстанавливаются заряды:
1. **При пересчете бонусов** (`recalculate_bonuses_from_learned_abilities()`)
   - Вызывается при загрузке игры
   - Вызывается при входе в бой
   - Устанавливает `current_charges = get_max_charges()`

2. **В комнате отдыха** (`restore_all_charges()`)
   - Вызывается при входе в комнату отдыха
   - Устанавливает `current_charges = get_max_charges()`

### Когда расходуются заряды:
- **При использовании восстановления души** (`use_charge()`)
  - Уменьшает `current_charges` на 1
  - Не изменяет максимум

## Пример нового вывода в консоль

### Правильный пересчет (изучена одна способность "Заряды I"):
```
=== НАЧАЛО ПЕРЕСЧЕТА БОНУСОВ ВОССТАНОВЛЕНИЯ ДУШИ ===
Текущие бонусы ДО пересчета:
  Заряды: 2
  Эффективность: 0.1
  Барьер: 80
Бонусы сброшены к нулю
Всего изученных способностей: 3
  Проверяем способность: soul_restoration_efficiency_1
Пересчет: Эффективность уровень 1 = +5.0%
  Проверяем способность: soul_restoration_charges_1
Пересчет: Заряды уровень 1 = +1 заряд
  Проверяем способность: soul_restoration_barrier_1
Пересчет: Барьер уровень 1 = 40
=== Итоговые бонусы восстановления души ===
Заряды: +1
Эффективность: +5.0%
Барьер: 40
Максимум зарядов: 3
Текущие заряды ДО восстановления: 2  ← старое значение
Текущие заряды ПОСЛЕ восстановления: 3  ← восстановлено!
```

**Результат в игре**: **3/3 заряда** ✅

## Изменения в файлах

### Scripts/Systems/SoulRestorationManager.gd
**Добавлено** в конце `recalculate_bonuses_from_learned_abilities()`:
- Вывод максимума зарядов
- Вывод текущих зарядов ДО восстановления
- Восстановление: `current_charges = get_max_charges()`
- Вывод текущих зарядов ПОСЛЕ восстановления

## Сценарии использования

### Сценарий 1: Изучение новой способности
1. Игрок изучает "Дополнительный заряд I"
2. Бонус применяется: `soul_upgrades["charges"] += 1`
3. Игрок входит в бой
4. **Пересчет**: бонусы пересчитываются, заряды восстанавливаются до максимума
5. **Результат**: 3/3 заряда ✅

### Сценарий 2: Загрузка игры
1. Игрок загружает сохранение с изученными способностями
2. `SoulRestorationManager._ready()` вызывает пересчет (с задержкой 0.1 сек)
3. **Пересчет**: бонусы пересчитываются, заряды восстанавливаются до максимума
4. **Результат**: Все заряды доступны ✅

### Сценарий 3: Использование зарядов в бою
1. Игрок использует 1 заряд: 3/3 → 2/3
2. Игрок завершает бой
3. Игрок входит в новый бой
4. **Пересчет**: заряды восстанавливаются до максимума
5. **Результат**: 3/3 заряда ✅

**Примечание**: Это правильное поведение! Заряды восстанавливаются при входе в новый бой (как дополнительная "комната отдыха").

### Сценарий 4: Комната отдыха
1. Игрок входит в комнату отдыха
2. Вызывается `restore_all_charges()`
3. **Восстановление**: `current_charges = get_max_charges()`
4. **Результат**: Все заряды восстанавливаются ✅

## Поведение системы

### Восстановление зарядов происходит:
- ✅ При загрузке игры (через пересчет)
- ✅ При входе в бой (через пересчет)
- ✅ В комнате отдыха (через `restore_all_charges()`)

### Заряды НЕ восстанавливаются:
- ❌ При открытии меню
- ❌ Автоматически во время боя
- ❌ При изучении новой способности (только при следующем входе в бой)

## Результат
✅ Текущие заряды теперь восстанавливаются до максимума после пересчета
✅ При входе в первый бой игрок видит 3/3 заряда (если изучена одна способность)
✅ Детальный вывод в консоль помогает отследить процесс восстановления
✅ Логика восстановления работает последовательно и предсказуемо

## Для пользователя

**Просто войдите в бой снова!**

Теперь при входе в бой вы увидите:
- В консоли: `Текущие заряды ПОСЛЕ восстановления: 3`
- В игре: **3/3 заряда** (если изучена одна способность "Дополнительный заряд I")

Каждый раз при входе в новый бой заряды будут восстанавливаться до максимума автоматически.

