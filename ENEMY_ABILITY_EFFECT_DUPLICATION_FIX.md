# Исправление дублирования эффектов вражеских способностей

## Проблема

В бою враги казались использующими активные способности без кулдауна, хотя у каждой способности прописан кулдаун. При анализе логов выяснилось, что эффект способности (например, `rat_bite_anim`) проигрывался **ДВАЖДЫ** за один ход:

```
DEBUG AbilityEffectManager: play_ability_effect_on_target вызван для ability_id='rat_bite'
...
DEBUG AbilityEffectManager: play_ability_effect_on_target вызван для ability_id='rat_bite'
```

Это создавало впечатление, что способность используется дважды подряд без задержки.

## Причина

Эффекты одноударных способностей проигрывались дважды:

1. **В общем блоке** (строки 1194-1204) - для всех одноударных способностей
2. **В специальном блоке** для конкретной способности - например, для `rat_bite` (строка 1506)

Хотя устанавливался флаг `result["effect_played"] = true` после первого проигрывания, он нигде не проверялся перед вторым проигрыванием.

## Затронутые способности

Все одноударные способности, которые имеют специальные блоки обработки:

- `rat_bite` (Крысиный укус)
- `crossbow_shot` (Арбалетный выстрел)
- `slashing_strike` (Рубящий удар)
- `poison_strike` (Ядовитый удар)
- `rending_claws` (Рвущие когти)
- `bat_swoop` (Пикирование)
- `acid_blast` (Кислотный взрыв)
- `shadow_spikes` (Теневые шипы)

## Решение

Добавлена проверка флага `effect_played` перед проигрыванием эффекта в специальных блоках:

```gdscript
# БЫЛО:
elif result.get("rat_bite", false):
    await get_tree().create_timer(0.35).timeout
    
    if ability_effect_manager:
        ability_effect_manager.play_ability_effect_on_target(player_node, "rat_bite", Vector2.ZERO, Vector2(2, 2), 100)

# СТАЛО:
elif result.get("rat_bite", false):
    # Проигрываем эффект только если он не был проигран в общем блоке
    if not result.get("effect_played", false):
        await get_tree().create_timer(0.35).timeout
        
        if ability_effect_manager:
            ability_effect_manager.play_ability_effect_on_target(player_node, "rat_bite", Vector2.ZERO, Vector2(2, 2), 100)
    else:
        # Эффект уже проигран, просто ждем
        await get_tree().create_timer(0.0).timeout
```

## Изменённые файлы

- `Scripts/Battle/battle_manager.gd`
  - Блок `rat_bite` (строка ~1498)
  - Блок `crossbow_shot` (строка ~1526)
  - Блок `slashing_strike` (строка ~1549)
  - Блок `poison_strike` (строка ~1390)
  - Блок `rending_claws` (строка ~1647)
  - Блок `bat_swoop` (строка ~1684)
  - Блок `acid_blast` (строка ~1737)
  - Блок `shadow_spikes` (строка ~1864)

## Способности без изменений

Многоударные способности (`double_strike`, `executioner_strike`, `crushing_strike`, `crushing_hammer`, `magic_arrows`, `tombstone`) исключены из общего блока проигрывания эффектов (строка 1147), поэтому их эффекты проигрываются только в специальных блоках и не дублируются.

## Результат

После исправления каждая вражеская способность проигрывает эффект только **один раз** за использование, и система кулдаунов работает корректно:

- Раунд 1: Враг использует способность → устанавливается кулдаун
- Раунд 2: Способность на перезарядке → враг использует базовую атаку
- Раунд 3+: Способность снова доступна (в зависимости от значения cooldown)

## Система кулдаунов (напоминание)

Значение `cooldown` в коде всегда на +1 больше, чем количество пропущенных ходов:

| Описание | Значение cooldown | Как работает |
|----------|------------------|--------------|
| Перезарядка 1 ход | `cooldown = 2` | Используется → 1 ход базовая атака → доступна |
| Перезарядка 2 хода | `cooldown = 3` | Используется → 2 хода базовая атака → доступна |
| Перезарядка 3 хода | `cooldown = 4` | Используется → 3 хода базовая атака → доступна |

Это происходит потому, что кулдаун уменьшается в начале хода врага, до проверки доступности способности.
