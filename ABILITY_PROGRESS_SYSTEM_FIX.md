# Исправление системы прогресса способностей

## Проблема

При накоплении очков прогресса (ОП) для способностей обнаружились следующие проблемы:

1. **Накопление прогресса без изучения**: Если игрок не изучал способность 1 уровня сразу после накопления 100 ОП, система продолжала копить прогресс на 2 и 3 уровни.

2. **Пропуск уровней**: Игрок мог изучить способность 2 или 3 уровня, не изучив предыдущие уровни, если накопил достаточно ОП.

3. **Нелогичная прогрессия**: Большая часть способностей показывала прогресс на 2 и 3 уровни, хотя 1 уровень не был изучен.

## Решение

### 1. Добавлена проверка предыдущего уровня

**В функции `can_learn_ability()`** (строка 643):
- Добавлена проверка, что для изучения уровня 2 необходимо изучить уровень 1
- Добавлена проверка, что для изучения уровня 3 необходимо изучить уровень 2
- Если предыдущий уровень не изучен, возвращается ошибка: "Требуется изучить предыдущий уровень"

```gdscript
# Проверяем, что предыдущий уровень изучен (если это не первый уровень)
if level > 1:
    var current_level = progress.get("current_level", 0)
    if current_level < level - 1:
        result.reason = "Требуется изучить предыдущий уровень"
        return result
```

**В функции `learn_ability()`** (строка 708):
- Добавлена аналогичная проверка при попытке изучить способность
- Если проверка не пройдена, изучение отменяется с сообщением в консоль

```gdscript
# Проверяем, что предыдущий уровень изучен (если это не первый уровень)
if level > 1:
    var current_level = progress.get("current_level", 0)
    if current_level < level - 1:
        print("Ошибка: Нельзя изучить уровень %d без изучения предыдущего уровня (текущий уровень: %d)" % [level, current_level])
        return false
```

### 2. Ограничено накопление прогресса

**В функции `_add_ability_progress()`** (строка 570):
- Добавлена логика ограничения максимального прогресса в зависимости от изученного уровня
- Прогресс теперь "останавливается" на требованиях следующего уровня

**Логика ограничений:**
- **Текущий уровень 0** (ничего не изучено): прогресс ограничен 100 ОП (требование для 1 уровня)
- **Текущий уровень 1**: прогресс ограничен 500 ОП (требование для 2 уровня)
- **Текущий уровень 2**: прогресс ограничен 1000 ОП (требование для 3 уровня)
- **Текущий уровень 3**: прогресс не накапливается (все уровни изучены)

```gdscript
# Ограничиваем прогресс в зависимости от изученного уровня
if config.required_progress is Array:
    var max_progress = 0
    if current_level == 0:
        # Если ничего не изучено, можем копить только до 1 уровня
        max_progress = config.required_progress[0]
    elif current_level == 1:
        # Если изучен 1 уровень, можем копить до 2 уровня
        max_progress = config.required_progress[1] if config.required_progress.size() > 1 else config.required_progress[0]
    elif current_level == 2:
        # Если изучен 2 уровень, можем копить до 3 уровня
        max_progress = config.required_progress[2] if config.required_progress.size() > 2 else config.required_progress[1]
    else:
        # Если изучены все уровни, прогресс не копится
        max_progress = 0
    
    # Ограничиваем прогресс максимумом
    if max_progress > 0 and progress.current_progress > max_progress:
        progress.current_progress = max_progress
```

## Результат

Теперь система прогресса способностей работает корректно:

1. ✅ **Последовательное изучение**: Игрок не может изучить уровень 2 без изучения уровня 1
2. ✅ **Ограничение прогресса**: ОП накапливаются только до требований следующего неизученного уровня
3. ✅ **Логичная прогрессия**: Игрок видит прогресс только для доступного уровня способности

## Пример работы

### До исправления:
- Игрок накопил 600 ОП для способности
- Не изучил уровень 1 (100 ОП)
- Видит, что может изучить уровень 2 (500 ОП) сразу ❌

### После исправления:
- Игрок накапливает ОП для способности
- Прогресс останавливается на 100 ОП (лимит для неизученного уровня 1)
- После изучения уровня 1, прогресс снова начинает копиться до 500 ОП (лимит для уровня 2) ✅
- И так далее для уровня 3

## Файлы изменены

- `Scripts/Systems/AbilityLearningSystem.gd`:
  - Функция `can_learn_ability()` - добавлена проверка предыдущего уровня
  - Функция `learn_ability()` - добавлена проверка предыдущего уровня
  - Функция `_add_ability_progress()` - добавлено ограничение накопления прогресса

