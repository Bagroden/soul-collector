# Система вариативности врагов

## Обзор
Система обеспечивает разнообразие боев через случайный выбор типов врагов и их редкостей в каждой комнате.

---

## Основные принципы

### 1. **Случайный выбор врагов**
- Каждый враг в комнате выбирается **независимо** из пула локации
- Разные враги могут появляться в одной комнате
- Примеры:
  - Комната 1: Крыса (common) + Крыса (rare) + Слизень (epic)
  - Комната 2: Летучая мышь (uncommon) + Крыса (legendary)

### 2. **Случайная редкость**
- Каждый враг получает **случайную редкость**
- Редкость зависит от **сложности локации**
- Редкости: `common`, `uncommon`, `rare`, `epic`, `legendary`
- Элитные версии: `elite_rare`, `elite_epic`, `elite_legendary`

---

## Веса редкостей по сложности

### **Сложность I (Легкая)**
```
Common:     45% ████████████████████████████████████████████████
Uncommon:   30% ████████████████████████████████
Rare:       15% ███████████████
Epic:        7% ███████
Legendary:   3% ███

Элитные:     3% шанс для rare/epic/legendary
```

### **Сложность II (Средняя)**
```
Common:     25% █████████████████████████
Uncommon:   35% ███████████████████████████████████
Rare:       25% █████████████████████████
Epic:       10% ██████████
Legendary:   5% █████

Элитные:     7% шанс для rare/epic/legendary
```

### **Сложность III (Тяжелая)**
```
Common:     10% ██████████
Uncommon:   20% ████████████████████
Rare:       30% ██████████████████████████████
Epic:       25% █████████████████████████
Legendary:  15% ███████████████

Элитные:    12% шанс для rare/epic/legendary
```

---

## Логика спавна

### **Обычные комнаты (Combat)**
1. Определяется количество врагов (1-3) на основе сложности
2. **Для КАЖДОГО врага:**
   - Случайно выбирается тип из пула локации
   - Случайно генерируется редкость с учетом весов
   - Проверяется шанс элитности
3. Враги спавнятся на свои позиции

### **Босс-комнаты (Boss)**
1. **Босс:** Фиксированная сцена + редкость `boss`
2. **Спутники (зависит от сложности):**
   - Сложность I: Босс **один**
   - Сложность II: Босс + **1 спутник** (rare-legendary)
   - Сложность III: Босс + **2 спутника** (rare-legendary)
3. Спутники выбираются случайно из пула локации

---

## Примеры боев

### **Пример 1: Сложность I, обычная комната**
```
Враг 1: Крыса (common, ур. 17)
Враг 2: Крыса (uncommon, ур. 18)
```

### **Пример 2: Сложность II, обычная комната**
```
Враг 1: Слизень (rare, ур. 19)
Враг 2: Крыса (epic, ур. 20)
Враг 3: Летучая мышь (uncommon, ур. 18)
```

### **Пример 3: Сложность III, обычная комната**
```
Враг 1: Гоблин Воин (elite_epic, ур. 25) ⭐ ЭЛИТНЫЙ
Враг 2: Гоблин Вор (legendary, ур. 22)
Враг 3: Крыса (rare, ур. 19)
```

### **Пример 4: Сложность III, босс-комната**
```
Босс:      Алкара Демон (boss, ур. 25)
Спутник 1: Гоблин Колдун (elite_legendary, ур. 24) ⭐ ЭЛИТНЫЙ
Спутник 2: Слизень (epic, ур. 21)
```

---

## Преимущества системы

### ✅ **Вариативность**
- Нет двух одинаковых боев
- Каждая комната уникальна
- Невозможно предсказать состав врагов

### ✅ **Прогрессия сложности**
- Сложность I: Безопасно, больше слабых врагов
- Сложность II: Баланс, разнообразие
- Сложность III: Челлендж, опасные враги

### ✅ **Стратегическая глубина**
- Разные типы врагов требуют разных подходов
- Редкость влияет на силу врага
- Элитные враги - особая угроза

### ✅ **Реиграбельность**
- Каждый забег уникален
- Новые комбинации врагов
- Разные тактики в каждом бою

---

## Технические детали

### **Файлы:**
- `Scripts/Battle/enemy_spawner.gd` - основная логика спавна
- `Scripts/Battle/battle_manager.gd` - определение количества врагов

### **Ключевые функции:**

#### `spawn_random_enemy() -> Node2D`
```gdscript
# Спавнит одного случайного врага:
# 1. Выбирает тип из пула локации
# 2. Генерирует случайную редкость
# 3. Проверяет элитность
# 4. Устанавливает уровень
```

#### `_get_random_rarity_weighted() -> String`
```gdscript
# Генерирует редкость с весами по сложности:
# 1. Получает текущую сложность
# 2. Выбирает таблицу весов
# 3. Делает взвешенный случайный выбор
# 4. Проверяет шанс элитности
```

---

## Настройка весов

Веса редкостей можно изменить в `enemy_spawner.gd`:

```gdscript
match difficulty:
    1:  # Сложность I
        weights = {
            "common": 45,      # ← Измените здесь
            "uncommon": 30,
            "rare": 15,
            "epic": 7,
            "legendary": 3
        }
```

Шансы элитности:
```gdscript
match difficulty:
    1: elite_chance = 0.03  # 3% ← Измените здесь
    2: elite_chance = 0.07  # 7%
    3: elite_chance = 0.12  # 12%
```

---

## Связанные системы

- **Множественные враги** (`MULTI_ENEMY_REFACTORING_PLAN.md`)
- **Редкость и пассивные способности** (`ALL_PASSIVE_ABILITIES.md`)
- **Система сложности** (`META_PROGRESSION_SYSTEM.md`)
- **Генерация комнат** (`RoomGenerator.gd`)

---

## История изменений

**22.11.2025:**
- ✅ Реализована независимая генерация типа и редкости для каждого врага
- ✅ Добавлены взвешенные таблицы редкостей по сложности
- ✅ Интегрирована система элитных врагов
- ✅ Отладочная печать информации о спавне

