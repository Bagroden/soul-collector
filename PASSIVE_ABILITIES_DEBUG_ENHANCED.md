# Усиленная отладка пассивных способностей

## Проблема
Пассивные способности не срабатывают в тестовом режиме. В боевом логе видны только урон и увороты, но нет информации о работе пассивных способностей.

## Анализ проблемы

### Что должно работать:
- **Пассивные способности найдены** - "Найденные пассивные способности: ["thief_agility", "dodge", "sneaky_strike", "neurotoxin"]"
- **Конфигурация корректна** - все способности правильно настроены
- **Логирование исправлено** - добавлены fallback пути

### Что не работает:
- **Пассивные способности не срабатывают** - нет логов о их работе
- **Только базовые события** - урон, увороты, но не пассивные способности
- **Нет информации о триггерах** - не видно, когда и как срабатывают способности

## Корневая причина

### Возможные причины:
1. **Пассивные способности не инициализируются** в тестовом режиме
2. **Триггеры не вызываются** в нужных моментах
3. **Способности не срабатывают** из-за неправильных условий
4. **Логирование не работает** несмотря на исправления

## Усиленная отладка

### Добавлена отладочная информация в `trigger_passive_abilities`:
```gdscript
func trigger_passive_abilities(trigger_type: PassiveAbility.TriggerType, target: Node = null, context: Dictionary = {}):
    print("=== ОТЛАДКА trigger_passive_abilities ===")
    print("Владелец: ", display_name)
    print("Тип триггера: ", trigger_type)
    print("Количество пассивных способностей: ", passive_abilities.size())
    print("Пассивные способности: ", passive_abilities.map(func(a): return a.name))
    
    for ability in passive_abilities:
        if ability.trigger_type == trigger_type:
            print("Срабатывает способность: ", ability.name, " (", ability.id, ")")
            # Добавляем уровень способности в контекст
            var ability_context = context.duplicate()
            ability_context["ability_level"] = ability_levels.get(ability.id, 1)
            var result = ability.trigger(self, target, ability_context)
            print("Результат: ", result)
            if result.get("success", false):
                _handle_ability_result(result, target)
                _log_passive_ability(ability.name, true, result.get("message", ""))
            else:
                # Логируем неудачное срабатывание только для способностей, которые должны срабатывать часто
                # (например, уворот, контратака), но не для статических способностей
                var should_log_failure = ability.id in ["dodge", "agility_dodge", "mouse_nimble", "quick_strike", "sneaky_strike"]
                if should_log_failure:
                    _log_passive_ability(ability.name, false, result.get("message", ""))
    
    print("=== КОНЕЦ ОТЛАДКИ trigger_passive_abilities ===")
```

## Ожидаемые результаты отладки

### При следующем запуске должно быть:
```
=== ОТЛАДКА trigger_passive_abilities ===
Владелец: Гоблин Вор
Тип триггера: PASSIVE
Количество пассивных способностей: 4
Пассивные способности: ["Ловкость вора", "Уворот", "Скрытый удар", "Нейротоксин"]
Срабатывает способность: Ловкость вора (thief_agility)
Результат: {"success": true, "message": "Ловкость вора активирована"}
Срабатывает способность: Уворот (dodge)
Результат: {"success": false, "message": "Уворот не сработал"}
Срабатывает способность: Скрытый удар (sneaky_strike)
Результат: {"success": false, "message": "Скрытый удар не сработал"}
Срабатывает способность: Нейротоксин (neurotoxin)
Результат: {"success": true, "message": "Нейротоксин активирован"}
=== КОНЕЦ ОТЛАДКИ trigger_passive_abilities ===
```

## Возможные проблемы и решения

### 1. **Пассивные способности не инициализируются**
**Симптом:** "Количество пассивных способностей: 0"
**Решение:** Проверить инициализацию в тестовом режиме

### 2. **Триггеры не вызываются**
**Симптом:** Нет сообщений "=== ОТЛАДКА trigger_passive_abilities ==="
**Решение:** Проверить вызовы в battle_manager.gd

### 3. **Способности не срабатывают**
**Симптом:** "Результат: {"success": false, "message": "..."}"
**Решение:** Проверить условия срабатывания в способностях

### 4. **Логирование не работает**
**Симптом:** Способности срабатывают, но не логируются
**Решение:** Проверить работу _log_passive_ability

## Следующие шаги

### 1. **Запустить тест с отладкой**
- Запустить тестовую арену
- Посмотреть на новые отладочные сообщения
- Определить, где именно проблема

### 2. **Проверить инициализацию**
- Убедиться, что пассивные способности загружаются
- Проверить, что они правильно назначаются врагу

### 3. **Проверить триггеры**
- Убедиться, что trigger_passive_abilities вызывается
- Проверить, что триггеры срабатывают в нужные моменты

### 4. **Проверить логирование**
- Убедиться, что _log_passive_ability работает
- Проверить, что сообщения попадают в боевой лог

## Ожидаемые результаты

### **Если все работает правильно:**
- Пассивные способности инициализируются
- Триггеры вызываются в нужные моменты
- Способности срабатывают и логируются
- Боевой лог содержит информацию о пассивных способностях

### **Если есть проблемы:**
- Отладочные сообщения покажут, где именно проблема
- Можно будет исправить конкретную проблему
- Боевой лог заработает как в обычном режиме

---

**Автор**: Claude AI Assistant  
**Дата**: 2024  
**Версия**: 1.0
