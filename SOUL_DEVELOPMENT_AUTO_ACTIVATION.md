# Автоматическая активация способностей развития души

## Дата
28 октября 2025

## Проблема
Способности развития души попадали на экран "Управление пассивными способностями", где их можно было активировать/деактивировать. Это неправильно, так как:
1. Эти способности должны работать автоматически после изучения
2. Они не должны требовать активации через духовную мощь
3. Они не должны отображаться в списке управляемых пассивных способностей

## Решение
Реализована система автоматической активации способностей развития души:
1. Исключение из экрана управления пассивными способностями
2. Автоматическое применение бонусов при инициализации системы
3. Автоматическое применение бонусов при изучении новой способности

## Изменения в коде

### Scripts/PlayerData.gd

#### 1. Фильтр в `get_available_passives_for_ui()`
```gdscript
func get_available_passives_for_ui() -> Array[Dictionary]:
    # ...
    for ability_id in learned_passives:
        var ability = passive_ability_manager.get_ability(ability_id)
        if ability:
            # ИСКЛЮЧАЕМ способности развития души
            if "soul" in ability.tags:
                continue
            # ... остальной код
```

**Результат**: Способности с тегом "soul" не попадают в список для экрана управления.

#### 2. Новая функция `_apply_soul_development_bonuses()`
```gdscript
func _apply_soul_development_bonuses():
    """Применяет бонусы от всех изученных способностей развития души"""
    if not passive_ability_manager:
        return
    
    # Проходим по всем изученным способностям
    for ability_id in learned_passives:
        var ability = passive_ability_manager.get_ability(ability_id)
        if ability and "soul" in ability.tags:
            # Применяем бонус от способности развития души
            ability.execute_ability(self)
            print("Применен бонус от способности развития души: ", ability.name)
```

**Функция**:
- Проходит по всем изученным способностям
- Находит способности с тегом "soul"
- Применяет их бонусы через `execute_ability()`

#### 3. Интеграция в `initialize_passive_system()`
```gdscript
func initialize_passive_system():
    """Инициализация системы пассивных способностей"""
    if not passive_ability_manager:
        # ... инициализация менеджера
    
    # Синхронизируем изученные способности
    _sync_learned_abilities_from_learning_system()
    
    # Применяем бонусы от способностей развития души
    _apply_soul_development_bonuses()
```

**Результат**: При каждой инициализации системы (включая загрузку игры) автоматически применяются бонусы от всех изученных способностей развития души.

## Когда применяются бонусы

### 1. При изучении новой способности
В `Scripts/UI/AbilityLearningScreen.gd`:
```gdscript
func _learn_soul_development_ability(ability_id: String, ability: PassiveAbility):
    # ... проверки
    
    # Списываем валюту
    if _spend_soul_ability_cost(ability.rarity):
        # Изучаем способность
        ability_learning_system.set_ability_learned(ability_id)
        player_data.learn_passive_ability(ability_id)
        
        # Применяем бонус способности
        ability.execute_ability(player_data)  # ← Применение бонуса
        
        # ... сохранение и обновление UI
```

**Момент**: Сразу после изучения способности, еще до сохранения.

### 2. При загрузке игры
В `Scripts/PlayerData.gd`:
```gdscript
func initialize_passive_system():
    # ...
    _apply_soul_development_bonuses()  # ← Применение всех бонусов
```

**Момент**: При каждой инициализации системы пассивных способностей (загрузка игры, открытие экранов и т.д.).

### 3. При входе в бой
В `Scripts/Battle/battle_manager.gd`:
```gdscript
func initialize_player():
    # ...
    player_data.initialize_passive_system()  # ← Вызов инициализации
    _apply_player_passive_abilities()
```

**Момент**: При подготовке к бою, перед применением других пассивных способностей.

## Типы способностей развития души

Все эти способности работают автоматически:

### 1. Эффективность восстановления (6 уровней)
- `restoration_efficiency_1` - `restoration_efficiency_6`
- **Эффект**: Увеличивает процент восстановления души

### 2. Заряды восстановления (6 уровней)
- `restoration_charges_1` - `restoration_charges_6`
- **Эффект**: Добавляет дополнительные заряды восстановления души

### 3. Барьер восстановления (6 уровней)
- `restoration_barrier_1` - `restoration_barrier_6`
- **Эффект**: Добавляет магический барьер при использовании восстановления души

### 4. Духовная мощь (5 уровней)
- `spiritual_power_1` - `spiritual_power_5`
- **Эффект**: Увеличивает максимальную духовную мощь

## Отличия от обычных пассивных способностей

| Характеристика | Обычные пассивки | Способности развития души |
|----------------|------------------|---------------------------|
| **Изучение** | Прогресс + осколки душ | Только валюта (ОД + души) |
| **Активация** | Требуется вручную | Автоматически |
| **Духовная мощь** | Расходуется | Не требуется |
| **Экран управления** | Отображаются | НЕ отображаются |
| **Деактивация** | Можно отключить | Всегда активны |
| **Применение** | Только при активации | Сразу при изучении |

## Проверка работоспособности

### Тест 1: Изучение способности
1. Изучить способность развития души
2. Проверить консоль: должно быть сообщение "Применен бонус от способности развития души: [название]"
3. Проверить эффект (например, для духовной мощи - увеличение максимальной духовной мощи)

### Тест 2: Экран управления
1. Изучить способность развития души
2. Открыть "Управление пассивными способностями"
3. Убедиться, что способность развития души НЕ отображается в списке

### Тест 3: Сохранение/Загрузка
1. Изучить несколько способностей развития души
2. Сохранить игру
3. Перезапустить игру
4. Проверить консоль: должны быть сообщения о применении бонусов
5. Проверить эффекты (заряды, барьер, духовная мощь и т.д.)

## Консольные сообщения

### При изучении способности
```
✅ Способность развития души изучена: [название]
Применен бонус от способности развития души: [название]
```

### При инициализации системы
```
Синхронизирована изученная способность: [ability_id]
Применен бонус от способности развития души: [название]
```

## Преимущества решения
1. ✅ Способности развития души работают всегда после изучения
2. ✅ Не требуют управления со стороны игрока
3. ✅ Не засоряют экран управления пассивными способностями
4. ✅ Не расходуют духовную мощь
5. ✅ Бонусы применяются автоматически при загрузке игры
6. ✅ Простая и понятная система для игрока

## Техническая реализация

### Тег "soul"
Все способности развития души имеют тег `"soul"` в массиве `tags`:
```gdscript
func _init():
    tags = ["soul"]  # ← Специальный тег
    # ...
```

### Фильтрация
Фильтрация происходит через проверку:
```gdscript
if "soul" in ability.tags:
    # Это способность развития души
    # Не показывать в списке управления
    # Применять бонусы автоматически
```

## Результат
✅ Способности развития души больше не попадают на экран управления пассивными способностями
✅ Их бонусы применяются автоматически при изучении
✅ Их бонусы сохраняются и применяются при загрузке игры
✅ Система работает независимо от системы активации обычных пассивных способностей

