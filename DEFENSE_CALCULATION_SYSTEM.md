# –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—â–∏—Ç—ã (Defense Calculation System)

## üìã –û–±–∑–æ—Ä

–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—á–µ—Ç–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –∑–∞—â–∏—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤.

---

## üéØ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞—â–∏—Ç—ã

### **1. –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞ (`defense`)**
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –≤ —Å—Ü–µ–Ω–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–ª–∏ —á–µ—Ä–µ–∑ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
- –î–ª—è –∏–≥—Ä–æ–∫–∞: `defense = 2` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ PlayerBody.tscn)
- –î–ª—è –≤—Ä–∞–≥–æ–≤: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ –∏ —É—Ä–æ–≤–Ω—è

### **2. –ë–æ–Ω—É—Å –æ—Ç –∂–∏–≤—É—á–µ—Å—Ç–∏ (`defense_from_vitality`)**
- **–§–æ—Ä–º—É–ª–∞:** `defense_from_vitality = vitality / 3`
- **–ü—Ä–∏–º–µ—Ä—ã:**
  - 15 –∂–∏–≤—É—á–µ—Å—Ç–∏ = +5 –∑–∞—â–∏—Ç—ã
  - 30 –∂–∏–≤—É—á–µ—Å—Ç–∏ = +10 –∑–∞—â–∏—Ç—ã
  - 45 –∂–∏–≤—É—á–µ—Å—Ç–∏ = +15 –∑–∞—â–∏—Ç—ã
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ `calculate_stat_bonuses()`

### **3. –ë–æ–Ω—É—Å—ã –æ—Ç –ø–∞—Å—Å–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π**
- –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `passive_defense_bonus` (PlayerData)
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–∞—Å—Å–∏–≤–∫–∏ –º–æ–≥—É—Ç –Ω–∞–ø—Ä—è–º—É—é —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å `defense` (–Ω–∞–ø—Ä–∏–º–µ—Ä, CurseCursed)
- –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—è —á–µ—Ä–µ–∑ `_apply_player_passive_abilities()`

### **4. –í—Ä–µ–º–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã**
- **–ë–∞—Ñ—ã:** —ç—Ñ—Ñ–µ–∫—Ç `"defense_buff"` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `defense_bonus`
- **–î–µ–±–∞—Ñ—ã:** –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `armor_reduction` (—É–º–µ–Ω—å—à–∞–µ—Ç –∑–∞—â–∏—Ç—É)
- –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤–æ –≤—Ä–µ–º—è –±–æ—è

### **5. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏**
- –≠—Ñ—Ñ–µ–∫—Ç `"armor_ignore"` –Ω–∞ —Ü–µ–ª–∏
- –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∑–∞—â–∏—Ç–∞ = 0 (–ø–æ–ª–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞: `get_effective_defense()`

### **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `Scripts/Battle/body.gd`

```gdscript
func get_effective_defense() -> int:
	"""–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –∑–∞—â–∏—Ç—É —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤"""
	var total_defense = defense  # –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞
	
	# –î–æ–±–∞–≤–ª—è–µ–º –±–æ–Ω—É—Å –æ—Ç –∂–∏–≤—É—á–µ—Å—Ç–∏
	total_defense += defense_from_vitality
	
	# –í—ã—á–∏—Ç–∞–µ–º —Å–Ω–∏–∂–µ–Ω–∏–µ –±—Ä–æ–Ω–∏ (–¥–µ–±–∞—Ñ—ã)
	total_defense -= armor_reduction
	
	# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–∏–µ –∑–∞—â–∏—Ç—É
	if "defense_buff" in effects:
		var buff = effects["defense_buff"]
		var bonus = buff.get("defense_bonus", 0)
		total_defense += bonus
	
	return max(0, total_defense)  # –ó–∞—â–∏—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π
```

### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

#### **–í –±–æ—é (take_damage):**
```gdscript
var effective_defense = get_effective_defense()

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏
if has_effect("armor_ignore"):
	effective_defense = 0
```

#### **–í UI (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ):**
```gdscript
if player.has_method("get_effective_defense"):
	effective_defense = player.get_effective_defense()
```

---

## üîÑ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

### **–ö–æ–≥–¥–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–∞:**

1. **–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫:**
   - –í—ã–∑—ã–≤–∞–µ—Ç—Å—è `calculate_stat_bonuses()` ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `defense_from_vitality`

2. **–ü—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤:**
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –±–∞—Ñ–æ–≤/–¥–µ–±–∞—Ñ–æ–≤ —á–µ—Ä–µ–∑ `add_effect()`/`remove_effect()`

3. **–ü—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Å—Å–∏–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π:**
   - –í –Ω–∞—á–∞–ª–µ –±–æ—è —á–µ—Ä–µ–∑ `_apply_player_passive_abilities()`

4. **–í UI:**
   - –ö–∞–∂–¥—ã–π –∫–∞–¥—Ä —á–µ—Ä–µ–∑ `_update_player_defensive_stats()` –∏ `_update_enemy_defensive_stats()`

---

## üìä –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—á–µ—Ç–∞

### **–ü—Ä–∏–º–µ—Ä 1: –ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞**
```
defense = 2
vitality = 14
defense_from_vitality = 14 / 3 = 4
armor_reduction = 0

get_effective_defense() = 2 + 4 - 0 = 6
```

### **–ü—Ä–∏–º–µ—Ä 2: –° –¥–µ–±–∞—Ñ–æ–º**
```
defense = 5
vitality = 30
defense_from_vitality = 30 / 3 = 10
armor_reduction = 3  # –î–µ–±–∞—Ñ –æ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

get_effective_defense() = 5 + 10 - 3 = 12
```

### **–ü—Ä–∏–º–µ—Ä 3: –° –±–∞—Ñ–æ–º**
```
defense = 2
vitality = 15
defense_from_vitality = 15 / 3 = 5
effects["defense_buff"] = {"defense_bonus": 5}

get_effective_defense() = 2 + 5 + 5 = 12
```

### **–ü—Ä–∏–º–µ—Ä 4: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏**
```
defense = 10
vitality = 30
defense_from_vitality = 10
has_effect("armor_ignore") = true

effective_defense = 0  # –ü–æ–ª–Ω–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ
```

---

## üé® –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ UI

### **–¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞:**
- **–ë–µ–ª—ã–π:** –ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
- **–ó–µ–ª–µ–Ω—ã–π:** –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ (–±–∞—Ñ—ã)
- **–û—Ä–∞–Ω–∂–µ–≤—ã–π:** –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ (–¥–µ–±–∞—Ñ—ã)
- **–ö—Ä–∞—Å–Ω—ã–π:** –ë—Ä–æ–Ω—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è

### **–ò–∫–æ–Ω–∫–∏:**
- **–§–∏–∑–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞:** `Shield_Phys.png`
- **–ú–∞–≥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ:** `Shield_Mage.png`

### **–ü–æ–∑–∏—Ü–∏—è:**
- –ü–æ–¥ –ø–æ–ª–æ—Å–∫–æ–π –∑–¥–æ—Ä–æ–≤—å—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
- –ò–≥—Ä–æ–∫: —Å–ø—Ä–∞–≤–∞ –æ—Ç HP –±–∞—Ä–∞
- –í—Ä–∞–≥: —Å–ª–µ–≤–∞ –æ—Ç HP –±–∞—Ä–∞

---

## üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤

### **–í—Ä–µ–º–µ–Ω–Ω—ã–π –±–∞—Ñ –∑–∞—â–∏—Ç—ã:**
```gdscript
# –î–æ–±–∞–≤–∏—Ç—å –±–∞—Ñ +5 –∑–∞—â–∏—Ç—ã –Ω–∞ 3 —Ä–∞—É–Ω–¥–∞
player.add_effect("defense_buff", 1.0, 3, {"defense_bonus": 5})
```

### **–î–µ–±–∞—Ñ (—Å–Ω–∏–∂–µ–Ω–∏–µ –±—Ä–æ–Ω–∏):**
```gdscript
# –°–Ω–∏–∑–∏—Ç—å –±—Ä–æ–Ω—é –Ω–∞ 3
target.armor_reduction += 3
```

### **–ü–∞—Å—Å–∏–≤–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –±–æ–Ω—É—Å):**
```gdscript
# –í PlayerData
player_data.passive_defense_bonus += 5

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ body
owner.defense += 5
```

### **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–æ–Ω–∏:**
```gdscript
# –°–ª–µ–¥—É—é—â–∞—è –∞—Ç–∞–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –±—Ä–æ–Ω—é —Ü–µ–ª–∏
target.add_effect("armor_ignore", 1.0, 1)
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏—Å—Ç–µ–º—ã

1. **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è:** –û–¥–∏–Ω –º–µ—Ç–æ–¥ –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
2. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:** –ü–æ–Ω—è—Ç–Ω–æ, –æ—Ç–∫—É–¥–∞ –±–µ—Ä–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
3. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
4. **–î–∏–Ω–∞–º–∏—á–Ω–æ—Å—Ç—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
5. **–û—Ç–ª–∞–¥–∫–∞:** –ü—Ä–æ—â–µ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –æ—à–∏–±–∫–∏ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö

---

## üêõ –û—Ç–ª–∞–¥–∫–∞

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –∑–∞—â–∏—Ç—ã:**
```gdscript
print("–ë–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞: ", defense)
print("–ë–æ–Ω—É—Å –æ—Ç –∂–∏–≤—É—á–µ—Å—Ç–∏: ", defense_from_vitality)
print("–°–Ω–∏–∂–µ–Ω–∏–µ –±—Ä–æ–Ω–∏: ", armor_reduction)
print("–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –∑–∞—â–∏—Ç–∞: ", get_effective_defense())
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤:**
```gdscript
print("–ê–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã: ", effects.keys())
if "defense_buff" in effects:
	print("–ë–∞—Ñ –∑–∞—â–∏—Ç—ã: ", effects["defense_buff"])
```

---

## üìù –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `Scripts/Battle/body.gd` - –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å —Ñ—É–Ω–∫—Ü–∏–µ–π `get_effective_defense()`
- `Scripts/PlayerData.gd` - –•—Ä–∞–Ω–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ (`passive_defense_bonus`)
- `Scripts/Battle/ui_controller.gd` - –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã –≤ UI
- `Scripts/Battle/battle_manager.gd` - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞

---

*–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω: 21.11.2025*

